<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="es-MX" xml:lang="es-MX"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Eric S. Téllez">

<title>Búsqueda en espacios métricos – Curso Introductorio a Julia y Recuperación de Información</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-95f147d06fdb9f8ce149f95e323965f4.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-c7dc29137db5525bd405bd4cb336165f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No se han encontrado resultados",
    "search-matching-documents-text": "documentos encontrados",
    "search-copy-link-title": "Copiar el enlace en la búsqueda",
    "search-hide-matches-text": "Ocultar resultados adicionales",
    "search-more-match-text": "resultado adicional en este documento",
    "search-more-matches-text": "resultados adicionales en este documento",
    "search-clear-button-title": "Borrar",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancelar",
    "search-submit-button-title": "Enviar",
    "search-label": "Buscar"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Curso Introductorio a Julia y Recuperación de Información</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Buscar"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Navegación de palanca" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Prefacio</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./02-data-vis.html"> 
<span class="menu-text">Dataframes y Visualización</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./03-IR.html"> 
<span class="menu-text">Recuperación de Información</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./04-text-IR.html"> 
<span class="menu-text">Búsqueda de Texto Completo</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./05-metric-IR.html" aria-current="page"> 
<span class="menu-text">Búsqueda en espacios métricos</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./06-about.html"> 
<span class="menu-text">Conclusiones</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Búsqueda en espacios métricos</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Código</button></div></div>
                      </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Autor/a</div>
    <div class="quarto-title-meta-heading">Afiliación</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author"><a href="https://sadit.github.io">Eric S. Téllez</a> <a href="mailto:eric.tellez@ieee.org" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              INFOTEC Centro de Investigación e Innovación en Tecnologías de la Información y Comunicación
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">En esta página</h2>
   
  <ul>
  <li><a href="#introducción" id="toc-introducción" class="nav-link active" data-scroll-target="#introducción">Introducción</a></li>
  <li><a href="#marco-teórico" id="toc-marco-teórico" class="nav-link" data-scroll-target="#marco-teórico">Marco teórico</a>
  <ul class="collapse">
  <li><a href="#k-vecinos-cercanos" id="toc-k-vecinos-cercanos" class="nav-link" data-scroll-target="#k-vecinos-cercanos"><span class="math inline">\(k\)</span> vecinos cercanos</a></li>
  </ul></li>
  <li><a href="#sobre-la-dimensión-intrínseca" id="toc-sobre-la-dimensión-intrínseca" class="nav-link" data-scroll-target="#sobre-la-dimensión-intrínseca">Sobre la dimensión intrínseca</a></li>
  <li><a href="#búsqueda-aproximada" id="toc-búsqueda-aproximada" class="nav-link" data-scroll-target="#búsqueda-aproximada">Búsqueda aproximada</a></li>
  <li><a href="#esquemas-de-búsqueda-de-k-vecinos-cercanos-en-gráficas" id="toc-esquemas-de-búsqueda-de-k-vecinos-cercanos-en-gráficas" class="nav-link" data-scroll-target="#esquemas-de-búsqueda-de-k-vecinos-cercanos-en-gráficas">Esquemas de búsqueda de <span class="math inline">\(k\)</span>-vecinos cercanos en gráficas</a></li>
  <li><a href="#bibliografía" id="toc-bibliografía" class="nav-link" data-scroll-target="#bibliografía">Bibliografía</a>
  <ul class="collapse">
  <li><a href="#ejemplo-de-uso-con-similaritysearch" id="toc-ejemplo-de-uso-con-similaritysearch" class="nav-link" data-scroll-target="#ejemplo-de-uso-con-similaritysearch">Ejemplo de uso con <code>SimilaritySearch</code></a>
  <ul class="collapse">
  <li><a href="#descargando-los-datos" id="toc-descargando-los-datos" class="nav-link" data-scroll-target="#descargando-los-datos">Descargando los datos</a></li>
  </ul></li>
  <li><a href="#búsqueda-por-fuerza-bruta-en-imágenes" id="toc-búsqueda-por-fuerza-bruta-en-imágenes" class="nav-link" data-scroll-target="#búsqueda-por-fuerza-bruta-en-imágenes">Búsqueda por fuerza bruta en imágenes</a></li>
  <li><a href="#búsqueda-con-texto---embeddings-de-jina-clip-v2" id="toc-búsqueda-con-texto---embeddings-de-jina-clip-v2" class="nav-link" data-scroll-target="#búsqueda-con-texto---embeddings-de-jina-clip-v2">Búsqueda con Texto - Embeddings de Jina Clip v2</a></li>
  <li><a href="#búsqueda-multimodal" id="toc-búsqueda-multimodal" class="nav-link" data-scroll-target="#búsqueda-multimodal">Búsqueda Multimodal</a></li>
  <li><a href="#búsqueda-con-índice" id="toc-búsqueda-con-índice" class="nav-link" data-scroll-target="#búsqueda-con-índice">Búsqueda con índice</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<nav id="TOC-body" role="doc-toc">
    <h2 id="toc-title">En esta página</h2>
   
  <ul>
  <li><a href="#introducción" id="toc-introducción">Introducción</a></li>
  <li><a href="#marco-teórico" id="toc-marco-teórico">Marco teórico</a>
  <ul>
  <li><a href="#k-vecinos-cercanos" id="toc-k-vecinos-cercanos"><span class="math inline">\(k\)</span> vecinos cercanos</a></li>
  </ul></li>
  <li><a href="#sobre-la-dimensión-intrínseca" id="toc-sobre-la-dimensión-intrínseca">Sobre la dimensión intrínseca</a></li>
  <li><a href="#búsqueda-aproximada" id="toc-búsqueda-aproximada">Búsqueda aproximada</a></li>
  <li><a href="#esquemas-de-búsqueda-de-k-vecinos-cercanos-en-gráficas" id="toc-esquemas-de-búsqueda-de-k-vecinos-cercanos-en-gráficas">Esquemas de búsqueda de <span class="math inline">\(k\)</span>-vecinos cercanos en gráficas</a></li>
  <li><a href="#bibliografía" id="toc-bibliografía">Bibliografía</a>
  <ul>
  <li><a href="#ejemplo-de-uso-con-similaritysearch" id="toc-ejemplo-de-uso-con-similaritysearch">Ejemplo de uso con <code>SimilaritySearch</code></a>
  <ul>
  <li><a href="#descargando-los-datos" id="toc-descargando-los-datos">Descargando los datos</a></li>
  </ul></li>
  <li><a href="#búsqueda-por-fuerza-bruta-en-imágenes" id="toc-búsqueda-por-fuerza-bruta-en-imágenes">Búsqueda por fuerza bruta en imágenes</a></li>
  <li><a href="#búsqueda-con-texto---embeddings-de-jina-clip-v2" id="toc-búsqueda-con-texto---embeddings-de-jina-clip-v2">Búsqueda con Texto - Embeddings de Jina Clip v2</a></li>
  <li><a href="#búsqueda-multimodal" id="toc-búsqueda-multimodal">Búsqueda Multimodal</a></li>
  <li><a href="#búsqueda-con-índice" id="toc-búsqueda-con-índice">Búsqueda con índice</a></li>
  </ul></li>
  </ul>
</nav>
<p>Los ejercicios de esta unidad estan en colab <a href="https://colab.research.google.com/drive/103qHTT_gyOiga8wjsUoWNCB5i__KiOEl?usp=sharing" class="uri">https://colab.research.google.com/drive/103qHTT_gyOiga8wjsUoWNCB5i__KiOEl?usp=sharing</a></p>
<section id="introducción" class="level2">
<h2 class="anchored" data-anchor-id="introducción">Introducción</h2>
<p>Los algoritmos de búsqueda son centrales en múltiples áreas de las ciencias de la computación; en particular en la recuperación de información. Este problema consiste en identificar rápidamente en una colección objetos que son cercanos a un ejemplo dado, este problema fue definido con respecto a documentos en la Unidad 2. En la presente unidad se generalizará el concepto.</p>
<p>La cercanía o similitud es representada mediante una función de distancia que da una perspectiva <em>geométrica</em> o <em>espacial</em> al problema. Una de las operaciones más importantes en la búsqueda por similitud es la recuperación de <span class="math inline">\(k\)</span> vecinos cercanos que consiste en encontrar los <span class="math inline">\(k\)</span> elementos más cercanos de una base de datos a una consulta dada.</p>
<p>El problema consiste en preprocesar una colección de datos, bajo alguna función de semejanza, para que la identificación de los objetos cercanos a una consulta pueda hacerse en tiempo que no dependa linealmente del tamaño de la colección. En otras palabras, que no sea necesario revisar todos los elementos de la base de datos para responder la consulta. La búsqueda de los <span class="math inline">\(k\)</span>-vecinos cercanos tiene aplicaciones en diferentes áreas, como parte operativa de algoritmos de <em>agrupamiento</em> <span class="citation" data-cites="SS2021">[@SS2021]</span> o como parte de la aceleración de dichos algoritmos <span class="citation" data-cites="YCC2020 SKL2011">[@YCC2020; @SKL2011]</span>. En procesamiento de lenguaje natural, la técnica es usada para diferentes objetivos, tal es el caso de recuperación de argumentos <span class="citation" data-cites="WPAA2017">[@WPAA2017]</span>, descubrimiento de estructuras semánticas <span class="citation" data-cites="DS2020">[@DS2020]</span>, búsqueda semántica <span class="citation" data-cites="SPA2019 FH2017">[@SPA2019; @FH2017]</span>, entre otras. En problemas de clasificación, el método de <span class="math inline">\(k\)</span> vecinos cercanos ha sido usado como uno de los métodos más simples y populares, y a la vez, efectivo <span class="citation" data-cites="GCVR2018 OTGMM2020">[@GCVR2018; @OTGMM2020]</span>. El cálculo de grafos de <em>todos</em> los vecinos cercanos es uno de los componentes de las técnicas de reducción de dimensión no-lineales, como UMAP <span class="citation" data-cites="MHM2018">[@MHM2018]</span>, TriMap <span class="citation" data-cites="AW2019">[@AW2019]</span>, o t-SNE <span class="citation" data-cites="VMH2018">[@VMH2018]</span>, además de las alternativas clásicas <span class="citation" data-cites="LV2017">[@LV2017]</span>. El proceso de reducción de dimensión es usado para incrementar el desempeño de algoritmos de aprendizaje computacional, así como en el proceso de análisis de los datos. Las dimensiones 2 y 3 nos permiten visualizar información de manera efectiva, y por tanto, una proyección fiel en baja dimensión siempre será de utilidad en el proceso de análisis de la información. Una de las partes más costosas del proceso de reducción de dimensión no lineal es la búsqueda de <span class="math inline">\(k\)</span>-vecinos cercanos, los algoritmos eficientes de búsqueda de vecinos son fundamentales para obtener en tiempos prácticos información de valor. Así mismo, asegurar la calidad de los vecinos es importante para confiar en las proyecciones que se obtienen.</p>
</section>
<section id="marco-teórico" class="level2">
<h2 class="anchored" data-anchor-id="marco-teórico">Marco teórico</h2>
<p>Una de las formalizaciones más flexibles de búsqueda por similitud consiste en representar el problema en términos de espacios métricos. Un espacio métrico <span class="math inline">\((U,d)\)</span> esta compuesto de un universo de objetos validos <span class="math inline">\(U\)</span> y una función de distancia <span class="math inline">\(d: U \times U \rightarrow \Re^+\)</span>. Para ser precisos, <span class="math inline">\(d\)</span> es una métrica por lo que para todo <span class="math inline">\(u,v,w \in U\)</span> cumple las siguientes propiedades:</p>
<ul>
<li><span class="math inline">\(d(u, v) \geq 0\)</span> y <span class="math inline">\(d(u,v)= 0 \iff u \equiv v\)</span> (positividad y equivalencia)</li>
<li><span class="math inline">\(d(u, v) = d(v, u)\)</span> (simetría), y finalmente,</li>
<li><span class="math inline">\(d(u, v) + d(v, w)  \leq d(u, w) \leq d(u, v) + d(v, w)\)</span> (desigualdad triangular).</li>
</ul>
<p>El problema principal de la búsqueda en espacios métricos consiste en, dado el conjunto finito <span class="math inline">\(S \subseteq U\)</span>, deseamos seleccionar elemento parecidos en <span class="math inline">\(S\)</span> a una consulta <span class="math inline">\(q \in U\)</span> bajo una definición consistente de similitud.</p>
<section id="k-vecinos-cercanos" class="level3">
<h3 class="anchored" data-anchor-id="k-vecinos-cercanos"><span class="math inline">\(k\)</span> vecinos cercanos</h3>
<p>Dado un universo de objetos validos <span class="math inline">\(U\)</span> y una función de distancia <span class="math inline">\(d\)</span>, y sea <span class="math inline">\(S\)</span> un subconjunto finito de <span class="math inline">\(U\)</span> y dadas la consulta <span class="math inline">\(q \in U\)</span> y el número entero positivo <span class="math inline">\(k\)</span>, el objetivo es encontrar <span class="math inline">\(R\)</span> de tamaño <span class="math inline">\(k\)</span> que minimiza <span class="math inline">\(\sum_{u \in R} d(u, q)\)</span>, para <span class="math inline">\(R \in 2^S\)</span>. Se suele denotar como <span class="math inline">\(k\text{nn}(S, q)\)</span>.</p>
<p>Existe una solución trivial para el problema, que consiste en evaluar <span class="math inline">\(d(q, u)\)</span> para todo <span class="math inline">\(u \in S\)</span>. Sin embargo, en el caso de interés, i.e., el tamaño de la colección de datos, <span class="math inline">\(n=|S|\)</span>, es muy grande y la evaluación exhaustiva de <span class="math inline">\(S\)</span> no escala. El problema se complica si adicionalmente la función <span class="math inline">\(d\)</span> es costosa de evaluar computacionalmente, como suele suceder en datos complejos. La solución a este problema es indexar o pre-procesar <span class="math inline">\(S\)</span>, de tal forma que se evite evaluar la distancia contra la mayor cantidad de elementos de <span class="math inline">\(S\)</span>.</p>
</section>
</section>
<section id="sobre-la-dimensión-intrínseca" class="level2">
<h2 class="anchored" data-anchor-id="sobre-la-dimensión-intrínseca">Sobre la dimensión intrínseca</h2>
<p>El modelo de espacios métricos proporciona simplicidad del marco de trabajo, ya que el universo <span class="math inline">\(U\)</span> de objetos puede estar definido por vectores en cualquier dimensión, secuencias de símbolos, documentos escritos en lenguaje natural, gráficas, distribuciones de probabilidad, o incluso conjuntos de elementos, que a su vez, podrían ser colecciones de los objetos antes mencionados. Con la flexibilidad y potencia descrita viene implícita una debilidad, la inherente dependencia en la <em>dimensionalidad intrínseca</em> de los datos, que podemos entenderla de manera informal como la información necesaria que necesita contener o representar un elemento del espacio métrico para ser distinguido entre todos los objetos validos. Chavez et al. <span class="citation" data-cites="CNBYM2001">[@CNBYM2001]</span> detallan una definición formal de la dimensionalidad intrínseca y de como es una generalización de la dimensión de un espacio vectorial. En términos prácticos, la dimensión intrínseca impacta principalmente de dos maneras, en primera instancia suele estar ligada con una función de distancia costosa, y segunda y más importante, destruye la capacidad de discriminación de los índices métricos tal que serán degradados a una evaluación exhaustiva. Lo anterior se debe al efecto que tiene la dimensión sobre la distribución de valores de distancia entre elementos de una colección. De manera más detallada, el aumento de la dimensión trae con sigo el incremento de la distancia mínima entre pares de elementos, y a su vez, la concentración alrededor de la media de las distancias entre objetos. Lo anterior se traduce como la incapacidad de usar la desigualdad del triángulo como filtro.</p>
<p>Desde el punto de vista del tamaño del conjunto de datos <span class="math inline">\(S\)</span>, el problema es evidentemente lineal sin utilizar un índice, ya que basta con evaluar todos los elementos para obtener el resultado exacto. Recientemente se ha probado con diversos formalismos que si la dimensión intrínseca de los datos es <em>suficientemente</em> alta, entonces con <em>cualquier</em> índice posible, la complejidad de la búsqueda sigue siendo lineal en el caso exacto y aún en el caso aproximado. El problema puede reducirse a un problema NP-completo <span class="citation" data-cites="AFN2004">[@AFN2004]</span>, como detalla Hetland <span class="citation" data-cites="Hetland2020">[@Hetland2020]</span>, quién reduce el problema de búsqueda al problema de <em>minimum dominating set</em>, un problema NP-completo clásico. Por otro lado, en 2018 Rubinstein probó que el problema de encontrar el par bicromático mas cercano tiene dureza cuadrática, lo cual implica que la búsqueda del vecino mas cercano tiene a su vez dureza lineal, aún en el sentido aproximado <span class="citation" data-cites="RUB2018">[@RUB2018]</span>. Estos resultados, y otros semejantes en la literatura obligan a buscar soluciones de índices sublineales en el sentido probabilístico.</p>
<p>Para abundar en lo anterior, la búsqueda de proximidad exacta requiere, por ejemplo, encontrar el vecino más cercano <em>exacto</em>; mientras que la búsqueda de proximidad aproximada da garantías de proximidad; lo que regresa estará a lo más <span class="math inline">\(\delta\)</span> veces más lejos que el verdadero vecino mas cercano. Los resultados descritos en el párrafo anterior establecen que no es posible crear un índice para cualquiera de estos dos casos. La única posibilidad de tener algoritmos verdaderamente sublineales es en el sentido probabilístico; es decir, <em>la mayor parte de las veces darán el resultado correcto</em>; pero cuando se equivocan el error cometido no está acotado.</p>
</section>
<section id="búsqueda-aproximada" class="level2">
<h2 class="anchored" data-anchor-id="búsqueda-aproximada">Búsqueda aproximada</h2>
<p>Con la finalidad de cuantificar la calidad en el sentido probabilístico, es necesario definir una medida de calidad; en la literatura se puede encontrar que el <em>recall</em> es una medida bien aceptada, y esta definida como sigue: <span class="math display">\[recall(S, q, k) = \frac{|k\text{nn}(S, q) \cap k\text{nn}^*(S, q)|}{k}, \]</span></p>
<p>donde <span class="math inline">\(k\)</span>nn calcula los <span class="math inline">\(k\)</span> vecinos de <span class="math inline">\(q\)</span> en <span class="math inline">\(S\)</span> de manera exacta y <span class="math inline">\(k\text{nn}^*\)</span> de manera aproximada, por lo que el valor de <em>recall</em> estará en el rango de 0 a 1, siendo 0 el peor y 1 el mejor.</p>
<p>Se busca que un índice para búsqueda aproximada tenga un costo computacional bajo, i.e., rápido y bajo uso en memoria; y a la vez tenga alta calidad en su aproximación, i.e., <em>recall</em> cercano a 1. Claramente, los objetivos se contraponen y es necesario encontrar los métodos que mejor se ajusten a las necesidades del problema a solucionar.</p>
</section>
<section id="esquemas-de-búsqueda-de-k-vecinos-cercanos-en-gráficas" class="level2">
<h2 class="anchored" data-anchor-id="esquemas-de-búsqueda-de-k-vecinos-cercanos-en-gráficas">Esquemas de búsqueda de <span class="math inline">\(k\)</span>-vecinos cercanos en gráficas</h2>
<p>En <span class="citation" data-cites="GLS2008">[@GLS2008]</span> se transforma el problema de búsqueda en espacios métricos al problema de navegación en una gráfica dónde los vértices representan al conjunto de datos y las aristas conexiones pesadas por un esquema especial de desorden con respecto a los vértices. Para resolver consultas se toma un vértice como inicio e iterativamente se reduce la distancia de los nodos visitados a la consulta. Este trabajo tiene un valor teórico importante, sin embargo, es poco útil en la práctica dados los costos computacionales envueltos en la construcción de la gráfica, sobre todo su memoria cuadrática. Chavez y Téllez <span class="citation" data-cites="CT2010">[@CT2010]</span> estudian una gráfica navegable inducida por la gráfica de todos los vecinos cercanos, tanto directos como reversos y describen como manejar las componentes dentro de la misma. Este algoritmo requiere la construcción de la gráfica de todos los <span class="math inline">\(k\)</span> vecinos cercanos, por lo que su construcción es muy costosa. Un algoritmo alternativo con un uso más reducido de memoria y construcciones más eficientes es el {} (RCT) <span class="citation" data-cites="HN2014">[@HN2014]</span>. En lugar de la construcción genérica de una gráfica, se crea un árbol, con un nodo raíz que siempre será usado para iniciar la búsqueda. Los nodos descendientes se obtienen por rango, i.e., orden al padre, y es la única información que se usa para la navegación. El grado de cada nodo es un parámetro que limita los requerimientos de memoria y el costo de las búsquedas, en intercambio con la calidad de los resultados.</p>
<p>En Malkov et al. <span class="citation" data-cites="MPLK2014">[@MPLK2014]</span> se introduce el índice <em>Navigable Small World</em> (NSW), un esquema novedoso con un desempeño notable. Dichos autores sugieren que la velocidad de búsqueda y precisión de NSW se debe a que su algoritmo de construcción captura las propiedades de <em>Mundo Pequeño</em> (<em>Small World</em>) de una base de datos métrica. Los requerimientos computacionales del NSW para su funcionamiento óptimo y el tiempo de construcción son altos, pero muy por debajo de esquemas anteriores. La construcción de NSW es incremental, se inserta un elemento a la vez, el algoritmo consiste en conectar el <span class="math inline">\(j\)</span>-ésimo elemento con sus <span class="math inline">\(k\)</span> vecinos cercanos aproximados tomados en los <span class="math inline">\(j-1\)</span> elementos previamente indexados. Las conexiones son no-dirigidas, por lo que el grafo resultante también es no-dirigido. El orden de inserción debe ser aleatorizado para evitar varios casos con muy mal desempeño. Finalmente, el número de vecinos, <span class="math inline">\(k\)</span>, es un parámetro crucial que debe ser optimizado para cada base de datos. En <span class="citation" data-cites="MYD2018">[@MYD2018]</span> se introduce una variante aún más veloz que consisten en una estructura jerárquica sobre la gráfica NSW; éste nuevo algoritmo reduce los peores casos y es capaz de reducir la memoria necesaria por la gráfica usando una selección más apropiada de las aristas que conectan los vértices. Ruiz et al. <span class="citation" data-cites="RCGT2015">[@RCGT2015]</span> introducen nuevos algoritmos para la navegación del NSW, los cuales son capaces de obtener resultados de mayor calidad a igualdad de memoria. Mas recientemente, Tellez et al. <span class="citation" data-cites="TRCG2021">[@TRCG2021]</span> presentan estrategias para calcular el grado de los vértices, y así mismo, de filtrado de los vértices que dan como resultado búsquedas más eficientes y gráficas más pequeñas. Dada la definición del NSW, la gráfica guarda información útil sobre la estructura de la colección de datos siendo representada, que hasta el momento ha sido poco explotada.</p>
</section>
<section id="bibliografía" class="level1">
<h1>Bibliografía</h1>
<ul>
<li><span class="citation" data-cites="AFN2004">[@AFN2004]</span> Alber, J., Fellows, M. R., &amp; Niedermeier, R. (2004). Polynomial-time data reduction for dominating set. Journal of the ACM (JACM), 51(3), 363-384.</li>
<li><span class="citation" data-cites="AW2019">[@AW2019]</span> Amid, E., &amp; Warmuth, M. K. (2019). TriMap: Large-scale dimensionality reduction using triplets. arXiv preprint arXiv:1910.00204.</li>
<li><span class="citation" data-cites="CNBYM2001">[@CNBYM2001]</span> Chávez, E., Navarro, G., Baeza-Yates, R., &amp; Marroquín, J. L. (2001). Searching in metric spaces. ACM computing surveys (CSUR), 33(3), 273-321.</li>
<li><span class="citation" data-cites="CT2010">[@CT2010]</span> Chávez, E., &amp; Tellez, E. S. (2010, September). Navigating k-nearest neighbor graphs to solve nearest neighbor searches. In Mexican Conference on Pattern Recognition (pp.&nbsp;270-280). Springer, Berlin, Heidelberg.</li>
<li><span class="citation" data-cites="DS2020">[@DS2020]</span> DS, D. (2020). A simple solution for the taxonomy enrichment task: Discovering hypernyms using nearest neighbor search.</li>
<li><span class="citation" data-cites="FH2017">[@FH2017]</span> Faessler, E., &amp; Hahn, U. (2017, July). Semedico: a comprehensive semantic search engine for the life sciences. In Proceedings of ACL 2017, System Demonstrations (pp.&nbsp;91-96).</li>
<li><span class="citation" data-cites="GCVR2018">[@GCVR2018]</span> Gallego, A. J., Calvo-Zaragoza, J., Valero-Mas, J. J., &amp; Rico-Juan, J. R. (2018). Clustering-based k-nearest neighbor classification for large-scale data with neural codes representation. Pattern Recognition, 74, 531-543.</li>
<li><span class="citation" data-cites="GLS2008">[@GLS2008]</span> Goyal, N., Lifshits, Y., &amp; Schütze, H. (2008, February). Disorder inequality: a combinatorial approach to nearest neighbor search. In Proceedings of the 2008 international conference on web search and data mining (pp.&nbsp;25-32).</li>
<li><span class="citation" data-cites="HN2014">[@HN2014]</span> Houle, M. E., &amp; Nett, M. (2014). Rank-based similarity search: Reducing the dimensional dependence. IEEE transactions on pattern analysis and machine intelligence, 37(1), 136-150.</li>
<li><span class="citation" data-cites="Hetland2020">[@Hetland2020]</span> Hetland, M. L. (2020, September). Optimal Metric Search Is Equivalent to the Minimum Dominating Set Problem. In International Conference on Similarity Search and Applications (pp.&nbsp;111-125). Springer, Cham.</li>
<li><span class="citation" data-cites="LV2017">[@LV2017]</span> Lee, J. A., &amp; Verleysen, M. (2007). Nonlinear dimensionality reduction (Vol. 1). New York: Springer.</li>
<li><span class="citation" data-cites="MHM2018">[@MHM2018]</span> McInnes, L., Healy, J., &amp; Melville, J. (2018). Umap: Uniform manifold approximation and projection for dimension reduction. arXiv preprint arXiv:1802.03426.</li>
<li><span class="citation" data-cites="MPLK2014">[@MPLK2014]</span> Malkov, Y., Ponomarenko, A., Logvinov, A., &amp; Krylov, V. (2014). Approximate nearest neighbor algorithm based on navigable small world graphs. Information Systems, 45, 61-68.</li>
<li><span class="citation" data-cites="MYD2018">[@MYD2018]</span> Malkov, Y. A., &amp; Yashunin, D. A. (2018). Efficient and robust approximate nearest neighbor search using hierarchical navigable small world graphs. IEEE transactions on pattern analysis and machine intelligence, 42(4), 824-836.</li>
<li><span class="citation" data-cites="OTGMM2020">[@OTGMM2020]</span> Ortiz-Bejar, J., Téllez, E. S., Graff, M., Moctezuma, D., &amp; Miranda-Jiménez, S. (2020). Improving k Nearest Neighbors and Naïve Bayes Classifiers Through Space Transformations and Model Selection. IEEE Access, 8, 221669-221688.</li>
<li><span class="citation" data-cites="RCGT2015">[@RCGT2015]</span> Ruiz, G., Chávez, E., Graff, M., &amp; Téllez, E. S. (2015, October). Finding near neighbors through local search. In International Conference on Similarity Search and Applications (pp.&nbsp;103-109). Springer, Cham.</li>
<li><span class="citation" data-cites="RUB2018">[@RUB2018]</span> Rubinstein, A. (2018, June). Hardness of approximate nearest neighbor search. In Proceedings of the 50th annual ACM SIGACT symposium on theory of computing (pp.&nbsp;1260-1268).</li>
<li><span class="citation" data-cites="SKL2011">[@SKL2011]</span> Pedregosa, F., Varoquaux, G., Gramfort, A., Michel, V., Thirion, B., Grisel, O., … &amp; Duchesnay, E. (2011). Scikit-learn: Machine learning in Python. the Journal of machine Learning research, 12, 2825-2830.</li>
<li><span class="citation" data-cites="SPA2019">[@SPA2019]</span> Soto, A. J., Przybyła, P., &amp; Ananiadou, S. (2019). Thalia: semantic search engine for biomedical abstracts. Bioinformatics, 35(10), 1799-1801.</li>
<li><span class="citation" data-cites="SS2021">[@SS2021]</span> Sharma, K. K., &amp; Seal, A. (2021). Spectral embedded generalized mean based k-nearest neighbors clustering with S-distance. Expert Systems with Applications, 169, 114326.</li>
<li><span class="citation" data-cites="TR2022">[@TR2022]</span> Tellez, E. S., &amp; Ruiz, G. (2022). Similarity search on neighbor’s graphs with automatic Pareto optimal performance and minimum expected quality setups based on hyperparameter optimization. arXiv preprint arXiv:2201.07917.</li>
<li><span class="citation" data-cites="TRCG2021">[@TRCG2021]</span> Tellez, E. S., Ruiz, G., Chavez, E., &amp; Graff, M. (2021). A scalable solution to the nearest neighbor search problem through local-search methods on neighbor graphs. Pattern Analysis and Applications, 24(2), 763-777.</li>
<li><span class="citation" data-cites="VMH2018">[@VMH2018]</span> Van der Maaten, L., &amp; Hinton, G. (2008). Visualizing data using t-SNE. Journal of machine learning research, 9(11).</li>
<li><span class="citation" data-cites="WPAA2017">[@WPAA2017]</span> Wachsmuth, H., Potthast, M., Al Khatib, K., Ajjour, Y., Puschmann, J., Qu, J., … &amp; Stein, B. (2017, September). Building an argument search engine for the web. In Proceedings of the 4th Workshop on Argument Mining (pp.&nbsp;49-59).</li>
<li><span class="citation" data-cites="YCC2020">[@YCC2020]</span> Yu, Q., Chen, K. H., &amp; Chen, J. J. (2020, September). Using a set of triangle inequalities to accelerate k-means clustering. In International Conference on Similarity Search and Applications (pp.&nbsp;297-311). Springer, Cham.</li>
</ul>
<section id="ejemplo-de-uso-con-similaritysearch" class="level2">
<h2 class="anchored" data-anchor-id="ejemplo-de-uso-con-similaritysearch">Ejemplo de uso con <code>SimilaritySearch</code></h2>
<div id="2" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">CSV</span>, <span class="bu">DataFrames</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">SimilaritySearch</span>, <span class="bu">StatsBase</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">PlotlyLight</span>, <span class="bu">JSON3</span>, <span class="bu">Cobweb</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">LinearAlgebra</span>, <span class="bu">HDF5</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>PlotlyLight.settings.use_iframe <span class="op">=</span> <span class="cn">true</span>  <span class="co"># necesario para quarto / jupyter / etc.</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>true</code></pre>
</div>
</div>
<section id="descargando-los-datos" class="level3">
<h3 class="anchored" data-anchor-id="descargando-los-datos">Descargando los datos</h3>
<p>Para estos ejemplos, estaremos usando el segmento de Español de la base de datos Wikipedia Image-Text (WIT); previamente se calcularon los encajes de las imágenes y el texto usando el modelo Jina CLIP v2 <a href="https://huggingface.co/jinaai/jina-clip-v2" class="uri">https://huggingface.co/jinaai/jina-clip-v2</a>.</p>
<div id="4" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> <span class="st">"WIT-es_jina-clip-v2_sample"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> !<span class="fu">isdir</span>(path)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">run</span>(<span class="ss">`git clone https://huggingface.co/datasets/sadit/WIT-es_jina-clip-v2_sample/`</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>La lectura de la base de datos vectorial se realizará con HDF5</p>
<div id="6" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>metaimages <span class="op">=</span> <span class="st">"</span><span class="sc">$</span>path<span class="st">/es-wit-images.tsv"</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>vecimages <span class="op">=</span> <span class="st">"</span><span class="sc">$</span>path<span class="st">/es-wit-images.h5"</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> <span class="fu">Matrix</span><span class="dt">{Float16}</span>(<span class="fu">h5read</span>(vecimages, <span class="st">"emb"</span>))</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>1024×318514 Matrix{Float16}:
 -0.9116    0.146    -1.663    -0.3271   …  -0.2583    1.117    -0.2664
  4.496     1.082     0.6924    4.164        1.444     3.73      2.361
  1.166    -0.9385   -3.037    -2.19         1.483    -0.4084   -2.309
  3.973     3.578     2.094    -0.841        2.078     3.725     2.709
  0.2686   -2.83     -2.121    -1.5205       1.729    -0.4478    1.403
 -1.938    -2.945    -1.264    -1.327    …  -0.4111   -2.363    -2.533
 -0.0851   -0.4343   -0.1952   -1.795        2.553    -1.731     1.567
  2.07     -0.4365    1.217     0.4392      -0.0975    2.232    -2.094
 -3.01     -0.1432   -1.505     0.5024      -0.4185   -2.9      -0.472
 -3.955    -0.7725    1.451     1.369       -4.367    -1.54     -3.855
  ⋮                                      ⋱                      
 -0.804     0.04886   0.306    -0.06165  …  -0.3684   -0.4897   -0.4978
  0.2059    0.08386   0.4778   -0.374       -0.1692    0.3005    0.02394
  0.06915  -0.164     0.3442   -0.1354       0.1407    0.10535   0.431
 -0.2593    0.1254    0.417    -0.4377       0.3865    0.2659    0.404
 -0.1729   -0.1938   -0.2198   -0.00975      0.4768   -0.06018   0.3657
  0.0629   -0.1782    0.10474  -0.1715   …  -0.5806    0.1943   -0.3857
  0.4314    0.2861    0.7065    0.5474       0.087     0.4092    0.1934
 -0.04266   0.0638    0.127     0.01243      0.07764  -0.03763  -0.04874
  0.2544    0.3604   -0.04514   0.1028       0.701     0.2524    0.1526</code></pre>
</div>
</div>
<p>En particular, se convirtió a números de punto flotante de precisión media; solo los procesadores más nuevos le sacan provecho a estas representaciones en SIMD, pero en cualquier caso nos sirve para mantener la base de datos en un tamaño razonable.</p>
<p>Ahora leemos los metadatos</p>
<div id="8" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>D <span class="op">=</span> CSV.<span class="fu">read</span>(metaimages, DataFrame)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(<span class="fu">names</span>(D))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Dict</span>(<span class="fu">pairs</span>(D[<span class="fl">1</span>, <span class="op">:</span>]))</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>19-element Vector{String}:
 "language"
 "page_url"
 "image_url"
 "page_title"
 "section_title"
 "hierarchical_section_title"
 "caption_reference_description"
 "caption_attribution_description"
 "caption_alt_text_description"
 "mime_type"
 "original_height"
 "original_width"
 "is_main_image"
 "attribution_passes_lang_id"
 "page_changed_recently"
 "context_page_description"
 "context_section_description"
 "ID"
 "image_url_sha256"</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>Dict{Symbol, Any} with 19 entries:
  :image_url_sha256                =&gt; "14f55329b6d8f9e7125ae6288af2e82807285f11…
  :ID                              =&gt; String15("00000_0000009")
  :caption_reference_description   =&gt; "Torreón en el castillo de Barcience, en …
  :context_section_description     =&gt; "Hacia 1427 contrajo matrimonio con Leono…
  :hierarchical_section_title      =&gt; "Juan de Silva y Meneses / Biografía / Pr…
  :page_url                        =&gt; "https://es.wikipedia.org/wiki/Juan_de_Si…
  :attribution_passes_lang_id      =&gt; false
  :section_title                   =&gt; "Primer matrimonio y ascenso en la Corte …
  :is_main_image                   =&gt; false
  :image_url                       =&gt; "http://upload.wikimedia.org/wikipedia/co…
  :page_title                      =&gt; "Juan de Silva y Meneses"
  :original_width                  =&gt; 960
  :page_changed_recently           =&gt; false
  :caption_attribution_description =&gt; "Castle of Barcience, near Maqueda, in th…
  :context_page_description        =&gt; "Juan de Silva y Meneses, noble y cortesa…
  :original_height                 =&gt; 1280
  :language                        =&gt; "es"
  :mime_type                       =&gt; String15("image/jpeg")
  :caption_alt_text_description    =&gt; missing</code></pre>
</div>
</div>
</section>
</section>
<section id="búsqueda-por-fuerza-bruta-en-imágenes" class="level2">
<h2 class="anchored" data-anchor-id="búsqueda-por-fuerza-bruta-en-imágenes">Búsqueda por fuerza bruta en imágenes</h2>
<p>Usando subconjuntos pequeños de la base de datos leída (Embeddings de imágenes con Jina CLIP v2), vamos a realizar algunas búsquedas.</p>
<div id="10" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fl">4</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>db, queries <span class="op">=</span> <span class="fu">MatrixDatabase</span>(X[<span class="op">:</span>, <span class="fl">1</span><span class="op">:</span>n]), <span class="fu">MatrixDatabase</span>(X[<span class="op">:</span>, n<span class="op">+</span><span class="fl">1</span><span class="op">:</span>n<span class="op">+</span><span class="fl">100</span>])</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>dist <span class="op">=</span> <span class="fu">SqL2_asf32</span>()</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>S <span class="op">=</span> <span class="fu">ExhaustiveSearch</span>(; db, dist)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>ctx <span class="op">=</span> <span class="fu">GenericContext</span>()</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>GenericContext{KnnSorted}(0, true, InformativeLog(1.0, Base.RefValue{Float64}(0.0), Base.Threads.SpinLock(0)))</code></pre>
</div>
</div>
<p>Ahora las búsquedas</p>
<div id="12" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>knns <span class="op">=</span> <span class="fu">searchbatch</span>(S, ctx, queries, <span class="fl">10</span>)</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>10×100 Matrix{IdWeight}:
 IdWeight(0x00000550, 97.6724)  …  IdWeight(0x0000078e, 71.1038)
 IdWeight(0x00001497, 103.409)     IdWeight(0x00001c94, 95.7726)
 IdWeight(0x00001ad9, 115.389)     IdWeight(0x0000067e, 106.031)
 IdWeight(0x000002a7, 171.187)     IdWeight(0x000024f1, 109.175)
 IdWeight(0x00000a4a, 172.74)      IdWeight(0x00001997, 112.583)
 IdWeight(0x00001b0b, 180.287)  …  IdWeight(0x00001368, 133.041)
 IdWeight(0x000021ea, 239.926)     IdWeight(0x00001f9f, 135.978)
 IdWeight(0x00000280, 258.994)     IdWeight(0x00000abc, 138.976)
 IdWeight(0x000025ba, 260.493)     IdWeight(0x00000c6a, 140.593)
 IdWeight(0x00001f6e, 265.5)       IdWeight(0x00001df4, 141.146)</code></pre>
</div>
</div>
<p>Podemos observar a que corresponde una de las consultas realizadas</p>
<div id="14" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>qID <span class="op">=</span> <span class="fl">100</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> D[<span class="fl">10_000</span> <span class="op">+</span> qID, <span class="op">:</span>]</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(<span class="fu">Dict</span>(<span class="fu">pairs</span>(r)))</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>h.<span class="fu">img</span>(src<span class="op">=</span>r.image_url, alt<span class="op">=</span>r.page_title, width<span class="op">=</span><span class="fl">160</span>)</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Dict{Symbol, Any} with 19 entries:
  :image_url_sha256                =&gt; "3ab0c3b127c7665e3aebe5679b2e3d379c346a9d…
  :ID                              =&gt; String15("00000_0231606")
  :caption_reference_description   =&gt; missing
  :context_section_description     =&gt; "Saint-Péran  es una población y comuna f…
  :hierarchical_section_title      =&gt; "Saint-Péran"
  :page_url                        =&gt; "https://es.wikipedia.org/wiki/Saint-P%C3…
  :attribution_passes_lang_id      =&gt; false
  :section_title                   =&gt; missing
  :is_main_image                   =&gt; true
  :image_url                       =&gt; "https://upload.wikimedia.org/wikipedia/c…
  :page_title                      =&gt; "Saint-Péran"
  :original_width                  =&gt; 2043
  :page_changed_recently           =&gt; false
  :caption_attribution_description =&gt; "Français&amp;#160;: Église de Saint-Péran.Br…
  :context_page_description        =&gt; "Saint-Péran es una población y comuna fr…
  :original_height                 =&gt; 3064
  :language                        =&gt; "es"
  :mime_type                       =&gt; String15("image/jpeg")
  :caption_alt_text_description    =&gt; missing</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<img src="https://upload.wikimedia.org/wikipedia/commons/e/e6/Saint-P%C3%A9ran_-_%C3%A9glise_02.JPG" alt="Saint-Péran" width="160">
</div>
</div>
<p>Ahora las respuestas</p>
<div id="16" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>children <span class="op">=</span> []</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> <span class="fu">view</span>(knns, <span class="op">:</span>, qID)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  r <span class="op">=</span> D[p.id, [<span class="op">:</span>image_url, <span class="op">:</span>page_url, <span class="op">:</span>page_title]]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">push!</span>(children,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    h.<span class="fu">div</span>(style<span class="op">=</span><span class="st">"display: inline-block; margin-left: 0.25cm;"</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>      h.<span class="fu">img</span>(src<span class="op">=</span>r.image_url, alt<span class="op">=</span>r.page_title, width<span class="op">=</span><span class="fl">160</span>), h.<span class="fu">br</span>(),</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>      h.<span class="fu">a</span>(r.page_title, href<span class="op">=</span>r.page_url)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> h.<span class="fu">div</span>(children)</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/a/ae/FranceNormandieSaintMartinLeBouillantEglise.jpg" alt="Saint-Martin-le-Bouillant" width="160"><br><a href="https://es.wikipedia.org/wiki/Saint-Martin-le-Bouillant">Saint-Martin-le-Bouillant</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/a/ad/FrancePaysDeLaLoireSaintAubinDuDesertEglise.jpg" alt="Saint-Aubin-du-Désert" width="160"><br><a href="https://es.wikipedia.org/wiki/Saint-Aubin-du-D%C3%A9sert">Saint-Aubin-du-Désert</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="http://upload.wikimedia.org/wikipedia/commons/4/45/FranceNormandiePercyEglise.jpg" alt="Percy (Mancha)" width="160"><br><a href="https://es.wikipedia.org/wiki/Percy_(Mancha)">Percy (Mancha)</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="http://upload.wikimedia.org/wikipedia/commons/0/03/FranceNormandieEtouvyEglise.jpg" alt="Étouvy" width="160"><br><a href="https://es.wikipedia.org/wiki/%C3%89touvy">Étouvy</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/4/4e/Eglise_de_Chateauponsac.jpg" alt="Tirso (santo)" width="160"><br><a href="https://es.wikipedia.org/wiki/Tirso_(santo)">Tirso (santo)</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/2/2e/Vue_de_l%27%C3%A9glise_Saint-%C3%89tienne.JPG" alt="Saint-Étienne-l'Allier" width="160"><br><a href="https://es.wikipedia.org/wiki/Saint-%C3%89tienne-l%27Allier">Saint-Étienne-l'Allier</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/a/a6/%C3%89glise_Saint-Jean-Baptiste_de_Taillepied.JPG" alt="Taillepied" width="160"><br><a href="https://es.wikipedia.org/wiki/Taillepied">Taillepied</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/f/f3/Frasnoy_%28Nord%2C_Fr%29_%C3%A9glise%2C_cot%C3%A9_tour.JPG" alt="Frasnoy" width="160"><br><a href="https://es.wikipedia.org/wiki/Frasnoy">Frasnoy</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/7/7c/Meilhards-church.jpg" alt="Meilhards" width="160"><br><a href="https://es.wikipedia.org/wiki/Meilhards">Meilhards</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/1/13/Dammartin-les-Templiers%2C_%C3%A9glise_-_img_44460.jpg" alt="Dammartin-les-Templiers" width="160"><br><a href="https://es.wikipedia.org/wiki/Dammartin-les-Templiers">Dammartin-les-Templiers</a></div></div>
</div>
</div>
<p>A continuación se muestran el histograma de distancias del 10-ésimo vecino cercano.</p>
<div id="18" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> <span class="fu">plot</span>()</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co">#p = plot(x = 1:20, y = cumsum(randn(20)), type="scatter", mode="lines+markers")  # Make plot</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>p.layout.title.text <span class="op">=</span> <span class="st">"knn distance histogram"</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>p.<span class="fu">histogram</span>(x<span class="op">=</span><span class="fu">convert</span>.(<span class="dt">Float32</span>, <span class="fu">view</span>(knns, <span class="fl">10</span>, <span class="op">:</span>)))</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<iframe srcdoc="<html><head><meta charset=&quot;utf-8&quot;><meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;><meta name=&quot;description&quot; content=&quot;PlotlyLight.jl Plot&quot;><title>PlotlyLight.jl</title><style>html, body { padding: 0px; margin: 0px; }</style><script src=&quot;https://cdn.plot.ly/plotly-2.35.2.min.js&quot; charset=&quot;utf-8&quot;></script></head><body><div class=&quot;plotlylight-parent&quot;><div class=&quot;plotlylight-plot-div&quot; style=&quot;height:100vh; width:100vw&quot; id=&quot;plotlyx-pnsjusbzrr&quot;></div><script>Plotly.newPlot(&quot;plotlyx-pnsjusbzrr&quot;,[{&quot;type&quot;:&quot;histogram&quot;,&quot;x&quot;:[265.50037,362.9355,251.52962,316.98166,396.0979,395.03336,425.55884,269.28714,328.38586,331.18866,261.68958,404.40536,437.3105,396.45245,533.3169,436.17334,337.87433,371.00922,349.27985,350.91504,485.2482,240.0353,334.03638,429.59247,491.2212,348.52814,389.62875,436.7011,380.88632,249.24792,337.24023,225.48091,386.10004,491.21042,455.87973,347.20258,429.7713,346.77734,468.4943,345.1293,309.89178,309.3969,421.45517,236.1104,431.21246,274.6833,218.68262,413.6911,334.851,356.6601,281.94147,388.10617,523.67175,414.01724,218.39648,430.052,474.51282,339.66333,501.6652,387.42358,389.7132,311.1147,343.44922,173.29645,325.37616,445.16135,302.61713,421.58105,331.1025,470.6722,249.91699,385.61688,192.20364,391.71817,422.3018,392.1233,303.56113,391.89948,315.486,609.595,359.24518,488.05008,324.40793,362.56042,290.07495,420.39706,251.74164,462.71378,317.41907,423.29547,390.38593,419.59412,268.02148,339.08484,471.15967,489.45013,494.13116,365.37854,238.71454,141.14615]}],{&quot;title&quot;:{&quot;text&quot;:&quot;knn distance histogram&quot;}},{&quot;responsive&quot;:true,&quot;displaylogo&quot;:false})</script></div></body></html>" style="display:block; border:none; min-height:350px; min-width:350px; width:100%; height:100%"></iframe>
</div>
</div>
</section>
<section id="búsqueda-con-texto---embeddings-de-jina-clip-v2" class="level2">
<h2 class="anchored" data-anchor-id="búsqueda-con-texto---embeddings-de-jina-clip-v2">Búsqueda con Texto - Embeddings de Jina Clip v2</h2>
<p>Ahora vamos a realizar las búsquedas en la modalidad de texto, usando nuevamente los embeddings de Jina CLIP v2.</p>
<div id="20" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>metatext <span class="op">=</span> <span class="st">"</span><span class="sc">$</span>path<span class="st">/es-wit-text.tsv"</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>vectext <span class="op">=</span> <span class="st">"</span><span class="sc">$</span>path<span class="st">/es-wit-text.h5"</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>Q <span class="op">=</span> <span class="fu">Matrix</span><span class="dt">{Float16}</span>(<span class="fu">h5read</span>(vectext, <span class="st">"emb"</span>))</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>DQ <span class="op">=</span> CSV.<span class="fu">read</span>(metatext, DataFrame)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(DQ)</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>19-element Vector{String}:
 "language"
 "page_url"
 "image_url"
 "page_title"
 "section_title"
 "hierarchical_section_title"
 "caption_reference_description"
 "caption_attribution_description"
 "caption_alt_text_description"
 "mime_type"
 "original_height"
 "original_width"
 "is_main_image"
 "attribution_passes_lang_id"
 "page_changed_recently"
 "context_page_description"
 "context_section_description"
 "ID"
 "image_url_sha256"</code></pre>
</div>
</div>
<p>Indexaremos un pequeño segmento</p>
<div id="22" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fl">4</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>db, queries <span class="op">=</span> <span class="fu">MatrixDatabase</span>(Q[<span class="op">:</span>, <span class="fl">1</span><span class="op">:</span>n]), <span class="fu">MatrixDatabase</span>(Q[<span class="op">:</span>, n<span class="op">+</span><span class="fl">1</span><span class="op">:</span>n<span class="op">+</span><span class="fl">100</span>])</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>S <span class="op">=</span> <span class="fu">ExhaustiveSearch</span>(; db, dist)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>knns <span class="op">=</span> <span class="fu">searchbatch</span>(S, ctx, queries, <span class="fl">10</span>)</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>10×100 Matrix{IdWeight}:
 IdWeight(0x000013fb, 176.251)  …  IdWeight(0x000014fa, 132.966)
 IdWeight(0x00001bab, 179.758)     IdWeight(0x00000d31, 154.491)
 IdWeight(0x00002280, 190.799)     IdWeight(0x000025b4, 167.495)
 IdWeight(0x00002663, 194.201)     IdWeight(0x00001d22, 175.824)
 IdWeight(0x000018bd, 196.033)     IdWeight(0x00000fe3, 175.925)
 IdWeight(0x000025a6, 199.787)  …  IdWeight(0x0000207d, 176.041)
 IdWeight(0x0000226f, 200.673)     IdWeight(0x000000d1, 177.714)
 IdWeight(0x000003fa, 201.174)     IdWeight(0x00000647, 184.847)
 IdWeight(0x00000915, 203.565)     IdWeight(0x000008b4, 186.362)
 IdWeight(0x00000e71, 205.645)     IdWeight(0x00002089, 187.546)</code></pre>
</div>
</div>
<p>Ahora veremos una de las consultas</p>
<div id="24" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>qID <span class="op">=</span> <span class="fl">100</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> DQ[<span class="fl">10_000</span> <span class="op">+</span> qID, <span class="op">:</span>]</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(<span class="fu">Dict</span>(<span class="fu">pairs</span>(r)))</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>h.<span class="fu">img</span>(src<span class="op">=</span>r.image_url, alt<span class="op">=</span>r.page_title, width<span class="op">=</span><span class="fl">160</span>)</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Dict{Symbol, Any} with 19 entries:
  :image_url_sha256                =&gt; "5466614e57c876674ad5347395651c1132f592b4…
  :ID                              =&gt; String15("00000_0211707")
  :caption_reference_description   =&gt; "Vista posterior de un Volkswagen Brasili…
  :context_section_description     =&gt; "En la mayoría de los mercados de América…
  :hierarchical_section_title      =&gt; "Volkswagen Brasilia / Primeros años"
  :page_url                        =&gt; "https://es.wikipedia.org/wiki/Volkswagen…
  :attribution_passes_lang_id      =&gt; false
  :section_title                   =&gt; "Primeros años"
  :is_main_image                   =&gt; false
  :image_url                       =&gt; "https://upload.wikimedia.org/wikipedia/c…
  :page_title                      =&gt; "Volkswagen Brasilia"
  :original_width                  =&gt; 328
  :page_changed_recently           =&gt; false
  :caption_attribution_description =&gt; "Português: Volkswagen Brasília Português…
  :context_page_description        =&gt; "El Volkswagen Brasilia fue un automóvil …
  :original_height                 =&gt; 245
  :language                        =&gt; "es"
  :mime_type                       =&gt; String15("image/jpeg")
  :caption_alt_text_description    =&gt; missing</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<img src="https://upload.wikimedia.org/wikipedia/commons/1/19/Volkswagen_brasilia2.jpg" alt="Volkswagen Brasilia" width="160">
</div>
</div>
<p>y los resultados asociados</p>
<div id="26" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>children <span class="op">=</span> []</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> <span class="fu">view</span>(knns, <span class="op">:</span>, qID)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  r <span class="op">=</span> DQ[p.id, [<span class="op">:</span>image_url, <span class="op">:</span>page_url, <span class="op">:</span>page_title]]</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">push!</span>(children,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    h.<span class="fu">div</span>(style<span class="op">=</span><span class="st">"display: inline-block; margin-left: 0.25cm;"</span>,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>      h.<span class="fu">img</span>(src<span class="op">=</span>r.image_url, alt<span class="op">=</span>r.page_title, width<span class="op">=</span><span class="fl">160</span>), h.<span class="fu">br</span>(),</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>      h.<span class="fu">a</span>(r.page_title, href<span class="op">=</span>r.page_url)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> h.<span class="fu">div</span>(children)</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/f/f9/Ford-royale_dos_puertas.jpg" alt="Ford Versailles" width="160"><br><a href="https://es.wikipedia.org/wiki/Ford_Versailles">Ford Versailles</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="http://upload.wikimedia.org/wikipedia/commons/c/cc/VW_Polo_Classic.jpg" alt="Volkswagen Polo III" width="160"><br><a href="https://es.wikipedia.org/wiki/Volkswagen_Polo_III">Volkswagen Polo III</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/c/c8/Motor_tipo2.JPG" alt="Motor Tipo" width="160"><br><a href="https://es.wikipedia.org/wiki/Motor_Tipo">Motor Tipo</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/8/8a/Museo_del_automovilismo21.jpg" alt="IKA-Renault Torino" width="160"><br><a href="https://es.wikipedia.org/wiki/IKA-Renault_Torino">IKA-Renault Torino</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/2/22/MercedesBenzMB13018012014.jpg" alt="Mercedes-Benz MB 100" width="160"><br><a href="https://es.wikipedia.org/wiki/Mercedes-Benz_MB_100">Mercedes-Benz MB 100</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/c/cb/Motor_Fiat_2000_16v_%281993%29.jpg" alt="Fiat Tempra" width="160"><br><a href="https://es.wikipedia.org/wiki/Fiat_Tempra">Fiat Tempra</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="http://upload.wikimedia.org/wikipedia/commons/a/a5/VW_Touran_Heck.JPG" alt="Volkswagen Touran" width="160"><br><a href="https://es.wikipedia.org/wiki/Volkswagen_Touran">Volkswagen Touran</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/8/8f/Placa_de_ve%C3%ADculo_Brasil_2011_Amazonas-S%C3%A3o_Sebasti%C3%A3o_do_Uatum%C3%A3_NOP_4567_motocicleta.jpg" alt="Matrículas automovilísticas de Brasil" width="160"><br><a href="https://es.wikipedia.org/wiki/Matr%C3%ADculas_automovil%C3%ADsticas_de_Brasil">Matrículas automovilísticas de Brasil</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/f/fd/Bx_19_gti_rear.jpg" alt="Citroën BX" width="160"><br><a href="https://es.wikipedia.org/wiki/Citro%C3%ABn_BX">Citroën BX</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="http://upload.wikimedia.org/wikipedia/commons/8/85/Opel_Ascona_A_Cockpit.JPG" alt="Opel Ascona" width="160"><br><a href="https://es.wikipedia.org/wiki/Opel_Ascona">Opel Ascona</a></div></div>
</div>
</div>
<p>Observemos el histograma de distancias</p>
<div id="28" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> <span class="fu">plot</span>()</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>p.layout.title.text <span class="op">=</span> <span class="st">"knn distance histogram - text "</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>p.<span class="fu">histogram</span>(x<span class="op">=</span><span class="fu">convert</span>.(<span class="dt">Float32</span>, <span class="fu">view</span>(knns, <span class="fl">10</span>, <span class="op">:</span>)))</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<iframe srcdoc="<html><head><meta charset=&quot;utf-8&quot;><meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;><meta name=&quot;description&quot; content=&quot;PlotlyLight.jl Plot&quot;><title>PlotlyLight.jl</title><style>html, body { padding: 0px; margin: 0px; }</style><script src=&quot;https://cdn.plot.ly/plotly-2.35.2.min.js&quot; charset=&quot;utf-8&quot;></script></head><body><div class=&quot;plotlylight-parent&quot;><div class=&quot;plotlylight-plot-div&quot; style=&quot;height:100vh; width:100vw&quot; id=&quot;plotlyx-qltuwoxtkg&quot;></div><script>Plotly.newPlot(&quot;plotlyx-qltuwoxtkg&quot;,[{&quot;type&quot;:&quot;histogram&quot;,&quot;x&quot;:[205.64456,219.08804,187.26715,196.34872,276.6077,238.62198,200.85129,207.07932,234.98386,195.74542,194.07788,174.56812,163.31091,170.67946,189.92044,256.117,202.01418,191.24078,182.44788,169.77385,181.15567,144.24422,209.71434,192.92236,199.76283,196.91028,142.45212,183.44159,186.54346,155.72229,163.95248,251.44856,196.84738,170.91196,167.2266,205.01128,184.30054,184.41461,198.26428,141.16835,175.37234,191.8652,187.3262,146.12343,163.95331,202.07695,236.92772,169.57632,198.00005,172.2992,174.46045,270.6467,242.48552,207.54955,208.57935,187.26764,190.81444,129.99448,166.33862,232.46156,191.70296,222.47531,151.69778,223.59563,168.56262,229.6274,191.68576,195.25299,141.31412,197.88284,218.36258,176.96072,209.42534,167.11623,198.67928,187.58743,175.34009,173.91185,155.69043,186.54156,177.52144,207.55151,178.3027,137.0307,270.14194,186.23776,167.5747,200.23672,213.44382,176.9073,178.255,249.64235,134.51529,158.15245,211.37097,133.7416,211.81209,161.04245,200.09343,187.54637]}],{&quot;title&quot;:{&quot;text&quot;:&quot;knn distance histogram - text &quot;}},{&quot;responsive&quot;:true,&quot;displaylogo&quot;:false})</script></div></body></html>" style="display:block; border:none; min-height:350px; min-width:350px; width:100%; height:100%"></iframe>
</div>
</div>
<p>Comparemos con el de imágenes que anteriormente calculamos.</p>
</section>
<section id="búsqueda-multimodal" class="level2">
<h2 class="anchored" data-anchor-id="búsqueda-multimodal">Búsqueda Multimodal</h2>
<p>Finalizaremos con búsqueda multimodal, con más datos</p>
<div id="30" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>db, queries <span class="op">=</span> <span class="fu">MatrixDatabase</span>(X), <span class="fu">MatrixDatabase</span>(Q[<span class="op">:</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">100</span>])</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>S <span class="op">=</span> <span class="fu">ExhaustiveSearch</span>(; db, dist)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="pp">@time</span> eknns <span class="op">=</span> <span class="fu">searchbatch</span>(S, ctx, queries, <span class="fl">10</span>)</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  0.273202 seconds (103 allocations: 12.734 KiB)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>10×100 Matrix{IdWeight}:
 IdWeight(0x0001a81a, 605.293)  …  IdWeight(0x0001710f, 601.911)
 IdWeight(0x00034b40, 608.942)     IdWeight(0x0001f3f7, 603.531)
 IdWeight(0x00032712, 610.634)     IdWeight(0x00015bd3, 615.286)
 IdWeight(0x00035216, 611.12)      IdWeight(0x00003b56, 623.938)
 IdWeight(0x00044d5f, 611.12)      IdWeight(0x0001194a, 625.19)
 IdWeight(0x00031a0c, 612.145)  …  IdWeight(0x00023b04, 627.171)
 IdWeight(0x000491cd, 613.351)     IdWeight(0x0003cfd4, 630.306)
 IdWeight(0x00017876, 615.067)     IdWeight(0x0002b7b1, 631.28)
 IdWeight(0x000481ac, 615.698)     IdWeight(0x0000ef2d, 632.689)
 IdWeight(0x00031b44, 616.111)     IdWeight(0x0004aa5a, 633.096)</code></pre>
</div>
</div>
<p>En este momento tenemos el conjunto de resultados <code>eknns</code>, el cual fue generado con una búsqueda exacta. Observa los tiempos.</p>
<p>Ahora veamos una de las consultas</p>
<div id="32" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>qID <span class="op">=</span> <span class="fl">7</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> DQ[qID, <span class="op">:</span>]</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(<span class="fu">Dict</span>(<span class="fu">pairs</span>(r)))</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>h.<span class="fu">img</span>(src<span class="op">=</span>r.image_url, alt<span class="op">=</span>r.page_title, width<span class="op">=</span><span class="fl">160</span>)</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Dict{Symbol, Any} with 19 entries:
  :image_url_sha256                =&gt; "735517acb164c7e062814d36a22d6f90f6dddb3e…
  :ID                              =&gt; String15("00000_0000116")
  :caption_reference_description   =&gt; missing
  :context_section_description     =&gt; "Tipo de Motor: Monocilíndrico, 4 Tiempos…
  :hierarchical_section_title      =&gt; "Suzuki GN 125 / Características"
  :page_url                        =&gt; "https://es.wikipedia.org/wiki/Suzuki_GN_…
  :attribution_passes_lang_id      =&gt; true
  :section_title                   =&gt; "Características"
  :is_main_image                   =&gt; false
  :image_url                       =&gt; "https://upload.wikimedia.org/wikipedia/c…
  :page_title                      =&gt; "Suzuki GN 125"
  :original_width                  =&gt; 1600
  :page_changed_recently           =&gt; true
  :caption_attribution_description =&gt; "Español: Suzuki GN 125"
  :context_page_description        =&gt; "La Suzuki GN 125 es una motocicleta mono…
  :original_height                 =&gt; 1200
  :language                        =&gt; "es"
  :mime_type                       =&gt; String15("image/jpeg")
  :caption_alt_text_description    =&gt; missing</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<img src="https://upload.wikimedia.org/wikipedia/commons/a/a1/Moto_de_Leandro_Lauro%2C_Suzuki_GN_125_H_%282%29.JPG" alt="Suzuki GN 125" width="160">
</div>
</div>
<p>Y sus respectivas respuestas</p>
<div id="34" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>children <span class="op">=</span> []</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> <span class="fu">view</span>(eknns, <span class="op">:</span>, qID)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  r <span class="op">=</span> D[p.id, [<span class="op">:</span>image_url, <span class="op">:</span>page_url, <span class="op">:</span>page_title]]</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">push!</span>(children,</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    h.<span class="fu">div</span>(style<span class="op">=</span><span class="st">"display: inline-block; margin-left: 0.25cm;"</span>,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>      h.<span class="fu">img</span>(src<span class="op">=</span>r.image_url, alt<span class="op">=</span>r.page_title, width<span class="op">=</span><span class="fl">160</span>), h.<span class="fu">br</span>(),</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>      h.<span class="fu">a</span>(r.page_title, href<span class="op">=</span>r.page_url)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> h.<span class="fu">div</span>(children)</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div><div style="display: inline-block; margin-left: 0.25cm;"><img src="http://upload.wikimedia.org/wikipedia/commons/a/a7/Kawasaki_Eliminator_125_DSC00126.JPG" alt="Kawasaki Eliminator" width="160"><br><a href="https://es.wikipedia.org/wiki/Kawasaki_Eliminator">Kawasaki Eliminator</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="http://upload.wikimedia.org/wikipedia/commons/e/ec/GS1100L.jpg" alt="Suzuki GS1100 (E, ES, G, GK, GL, L, S)" width="160"><br><a href="https://es.wikipedia.org/wiki/Suzuki_GS1100_(E,_ES,_G,_GK,_GL,_L,_S)">Suzuki GS1100 (E, ES, G, GK, GL, L, S)</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/7/73/Diagrama_RSN.png" alt="Redes semánticas naturales" width="160"><br><a href="https://es.wikipedia.org/wiki/Redes_sem%C3%A1nticas_naturales">Redes semánticas naturales</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/e/ee/NortonCommandoMKIIA.jpg" alt="Norton Motorcycle Company" width="160"><br><a href="https://es.wikipedia.org/wiki/Norton_Motorcycle_Company">Norton Motorcycle Company</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/e/ee/NortonCommandoMKIIA.jpg" alt="Motor de dos cilindros en línea" width="160"><br><a href="https://es.wikipedia.org/wiki/Motor_de_dos_cilindros_en_l%C3%ADnea">Motor de dos cilindros en línea</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/b/b3/Kawasaki_W650_2000_Retro_Bevel_Drive_Side.jpg" alt="Kawasaki W650" width="160"><br><a href="https://es.wikipedia.org/wiki/Kawasaki_W650">Kawasaki W650</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/0/00/ECS_BYTE_Offer_Letter_June_1975_pg1.jpg" alt="Byte (revista)" width="160"><br><a href="https://es.wikipedia.org/wiki/Byte_(revista)">Byte (revista)</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="http://upload.wikimedia.org/wikipedia/commons/b/ba/Honda_cx500_1981_blue_rhs.jpg" alt="Serie Honda CX" width="160"><br><a href="https://es.wikipedia.org/wiki/Serie_Honda_CX">Serie Honda CX</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/8/81/Obleagnc.png" alt="Gas natural comprimido" width="160"><br><a href="https://es.wikipedia.org/wiki/Gas_natural_comprimido">Gas natural comprimido</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/2/21/Honda_Innova_2007_gris.jpg" alt="Honda Wave" width="160"><br><a href="https://es.wikipedia.org/wiki/Honda_Wave">Honda Wave</a></div></div>
</div>
</div>
<p>Observemos el histograma de distancias y compare con los histogramas pasados.</p>
<div id="36" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> <span class="fu">plot</span>()</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>p.layout.title.text <span class="op">=</span> <span class="st">"knn distance histogram - multimodal "</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>p.<span class="fu">histogram</span>(x<span class="op">=</span><span class="fu">convert</span>.(<span class="dt">Float32</span>, <span class="fu">view</span>(eknns, <span class="fl">10</span>, <span class="op">:</span>)))</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<iframe srcdoc="<html><head><meta charset=&quot;utf-8&quot;><meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;><meta name=&quot;description&quot; content=&quot;PlotlyLight.jl Plot&quot;><title>PlotlyLight.jl</title><style>html, body { padding: 0px; margin: 0px; }</style><script src=&quot;https://cdn.plot.ly/plotly-2.35.2.min.js&quot; charset=&quot;utf-8&quot;></script></head><body><div class=&quot;plotlylight-parent&quot;><div class=&quot;plotlylight-plot-div&quot; style=&quot;height:100vh; width:100vw&quot; id=&quot;plotlyx-egggtnsdxj&quot;></div><script>Plotly.newPlot(&quot;plotlyx-egggtnsdxj&quot;,[{&quot;type&quot;:&quot;histogram&quot;,&quot;x&quot;:[616.11084,635.45605,637.0803,651.08777,639.45825,707.5231,732.46594,648.3557,636.6881,648.3023,635.6843,618.43494,634.28625,573.7157,639.1532,669.718,639.4857,657.72473,696.5674,623.1245,624.1621,627.9716,614.0053,649.3762,623.6111,640.8579,685.8071,653.579,648.8375,582.7557,616.86066,636.39655,662.9824,598.2416,644.2364,672.21625,599.5984,679.3215,730.9042,641.5776,657.4158,598.0437,657.8053,642.1494,599.0949,625.6293,688.855,671.17334,662.2425,661.7044,632.9502,662.7363,642.47095,674.1728,629.8949,716.9863,618.50116,623.6073,624.85974,616.08203,655.91223,643.8335,622.078,617.45715,643.5355,662.749,653.24097,638.0846,625.78625,676.4361,652.1956,610.1084,667.274,675.94617,638.8904,697.072,650.01294,676.63837,720.5722,624.4866,660.1457,566.99243,664.6105,641.2189,641.0554,590.5133,619.87036,731.94257,641.1808,700.0081,640.23926,696.1235,665.1376,599.683,623.32837,677.8589,683.1884,644.95465,680.99133,633.0964]}],{&quot;title&quot;:{&quot;text&quot;:&quot;knn distance histogram - multimodal &quot;}},{&quot;responsive&quot;:true,&quot;displaylogo&quot;:false})</script></div></body></html>" style="display:block; border:none; min-height:350px; min-width:350px; width:100%; height:100%"></iframe>
</div>
</div>
</section>
<section id="búsqueda-con-índice" class="level2">
<h2 class="anchored" data-anchor-id="búsqueda-con-índice">Búsqueda con índice</h2>
<p>Ahora veremos como hacerlo más eficiente</p>
<div id="38" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>G <span class="op">=</span> <span class="fu">SearchGraph</span>(; db, dist)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>gctx <span class="op">=</span> <span class="fu">SearchGraphContext</span>(</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  hyperparameters_callback<span class="op">=</span><span class="fu">OptimizeParameters</span>(<span class="fu">MinRecall</span>(<span class="fl">0.99</span>))</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="pp">@time</span> <span class="fu">index!</span>(G, gctx)</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>LOG add_vertex! sp=1 ep=1 n=1 BeamSearch(bsize=4, Δ=1.0, maxvisits=1000000) 2025-10-20T19:32:50.404
LOG n.size quantiles:[0.0, 0.0, 0.0, 0.0, 0.0]
LOG add_vertex! sp=514 ep=770 n=513 BeamSearch(bsize=15, Δ=1.4039096, maxvisits=864) 2025-10-20T19:32:54.351
LOG n.size quantiles:[1.0, 3.0, 4.0, 6.0, 9.0]
LOG add_vertex! sp=64764 ep=65020 n=64763 BeamSearch(bsize=16, Δ=1.2762815, maxvisits=3846) 2025-10-20T19:32:55.356
LOG n.size quantiles:[1.0, 4.0, 5.0, 7.0, 12.0]
LOG add_vertex! sp=105113 ep=105369 n=105112 BeamSearch(bsize=11, Δ=1.157625, maxvisits=2000) 2025-10-20T19:32:56.356
LOG n.size quantiles:[1.0, 4.0, 5.0, 7.0, 12.0]
LOG add_vertex! sp=151373 ep=151629 n=151372 BeamSearch(bsize=13, Δ=1.1851876, maxvisits=2328) 2025-10-20T19:32:57.362
LOG n.size quantiles:[1.0, 4.0, 5.0, 7.0, 12.0]
LOG add_vertex! sp=190951 ep=191207 n=190950 BeamSearch(bsize=13, Δ=1.1851876, maxvisits=2328) 2025-10-20T19:32:58.370
LOG n.size quantiles:[1.0, 4.0, 6.0, 7.0, 12.0]
LOG add_vertex! sp=208170 ep=208426 n=208169 BeamSearch(bsize=20, Δ=1.3400955, maxvisits=3034) 2025-10-20T19:32:59.378
LOG n.size quantiles:[1.0, 4.0, 5.0, 7.0, 13.0]
LOG add_vertex! sp=227702 ep=227958 n=227701 BeamSearch(bsize=20, Δ=1.3400955, maxvisits=3034) 2025-10-20T19:33:00.396
LOG n.size quantiles:[1.0, 4.0, 6.0, 7.0, 12.0]
LOG add_vertex! sp=246720 ep=246976 n=246719 BeamSearch(bsize=20, Δ=1.3400955, maxvisits=3034) 2025-10-20T19:33:01.396
LOG n.size quantiles:[1.0, 4.0, 6.0, 7.0, 14.0]
LOG add_vertex! sp=260598 ep=260854 n=260597 BeamSearch(bsize=20, Δ=1.3400955, maxvisits=3034) 2025-10-20T19:33:02.409
LOG n.size quantiles:[1.0, 4.0, 6.0, 7.0, 13.0]
LOG add_vertex! sp=270364 ep=270620 n=270363 BeamSearch(bsize=20, Δ=1.3400955, maxvisits=3034) 2025-10-20T19:33:03.430
LOG n.size quantiles:[1.0, 4.0, 6.0, 7.0, 12.0]
LOG add_vertex! sp=280130 ep=280386 n=280129 BeamSearch(bsize=20, Δ=1.3400955, maxvisits=3034) 2025-10-20T19:33:04.448
LOG n.size quantiles:[1.0, 4.0, 6.0, 7.0, 12.0]
LOG add_vertex! sp=289125 ep=289381 n=289124 BeamSearch(bsize=10, Δ=1.155, maxvisits=1508) 2025-10-20T19:33:05.454
LOG n.size quantiles:[1.0, 4.0, 5.0, 6.0, 14.0]
 17.046779 seconds (10.62 M allocations: 646.051 MiB, 1.01% gc time, 39.10% compilation time)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>SearchGraph{SqL2_asf32, MatrixDatabase{Matrix{Float16}}, SimilaritySearch.AdjacencyLists.AdjacencyList{UInt32}, Vector{UInt32}}
  dist: SqL2_asf32 SqL2_asf32()
  db: MatrixDatabase{Matrix{Float16}}
  adj: SimilaritySearch.AdjacencyLists.AdjacencyList{UInt32}
  hints: Array{UInt32}((70,)) UInt32[0x00007ded, 0x00005bd5, 0x0001c497, 0x000170c6, 0x00002e33, 0x00035a01, 0x0004236d, 0x0002ba18, 0x00008528, 0x0000635a  …  0x0001e3ad, 0x00035f1e, 0x00003ca9, 0x0001dc11, 0x0000616b, 0x00021c52, 0x00004896, 0x00037430, 0x00020d32, 0x00038011]
  algo: Base.RefValue{BeamSearch}
  len: Base.RefValue{Int64}</code></pre>
</div>
</div>
<p>Optimizamos para cierta calidad</p>
<div id="40" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@time</span> <span class="fu">optimize_index!</span>(G, gctx, <span class="fu">MinRecall</span>(<span class="fl">0.9</span>))</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  0.238732 seconds (106.68 k allocations: 6.114 MiB, 36.89% compilation time)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>16-element Vector{Pair}:
 BeamSearch(bsize=8, Δ=0.93333334, maxvisits=1000000) =&gt; (visited = (min = 156, mean = 285.5, max = 491), radius = (min = 95.30998229980469, mean = 232.6460598707199, max = 603.2361450195312), recall = 0.9249999999999998, searchtime = 5.21059375e-6, conf = BeamSearch(bsize=8, Δ=0.93333334, maxvisits=1000000))
       BeamSearch(bsize=8, Δ=0.94, maxvisits=1000000) =&gt; (visited = (min = 156, mean = 286.09375, max = 491), radius = (min = 95.30998229980469, mean = 232.64173305034637, max = 602.959228515625), recall = 0.9249999999999998, searchtime = 5.2804375e-6, conf = BeamSearch(bsize=8, Δ=0.94, maxvisits=1000000))
 BeamSearch(bsize=8, Δ=0.94285715, maxvisits=1000000) =&gt; (visited = (min = 156, mean = 286.171875, max = 491), radius = (min = 95.30998229980469, mean = 232.7142585515976, max = 602.959228515625), recall = 0.9249999999999998, searchtime = 5.5796875e-6, conf = BeamSearch(bsize=8, Δ=0.94285715, maxvisits=1000000))
       BeamSearch(bsize=8, Δ=0.95, maxvisits=1000000) =&gt; (visited = (min = 156, mean = 287.421875, max = 495), radius = (min = 95.30998229980469, mean = 235.39775788784027, max = 602.959228515625), recall = 0.9093749999999998, searchtime = 5.58803125e-6, conf = BeamSearch(bsize=8, Δ=0.95, maxvisits=1000000))
 BeamSearch(bsize=8, Δ=0.95238096, maxvisits=1000000) =&gt; (visited = (min = 156, mean = 287.78125, max = 493), radius = (min = 95.30998229980469, mean = 235.39775788784027, max = 602.959228515625), recall = 0.9093749999999998, searchtime = 5.79609375e-6, conf = BeamSearch(bsize=8, Δ=0.95238096, maxvisits=1000000))
       BeamSearch(bsize=8, Δ=0.98, maxvisits=1000000) =&gt; (visited = (min = 156, mean = 288.109375, max = 507), radius = (min = 95.30998229980469, mean = 235.10238301753998, max = 602.959228515625), recall = 0.9109374999999998, searchtime = 5.70715625e-6, conf = BeamSearch(bsize=8, Δ=0.98, maxvisits=1000000))
       BeamSearch(bsize=8, Δ=0.99, maxvisits=1000000) =&gt; (visited = (min = 156, mean = 288.359375, max = 473), radius = (min = 95.30998229980469, mean = 234.93925750255585, max = 602.957763671875), recall = 0.9140624999999999, searchtime = 5.277109375e-6, conf = BeamSearch(bsize=8, Δ=0.99, maxvisits=1000000))
       BeamSearch(bsize=8, Δ=0.97, maxvisits=1000000) =&gt; (visited = (min = 156, mean = 288.484375, max = 496), radius = (min = 95.30998229980469, mean = 235.35209786891937, max = 602.959228515625), recall = 0.9093749999999998, searchtime = 5.089171875e-6, conf = BeamSearch(bsize=8, Δ=0.97, maxvisits=1000000))
       BeamSearch(bsize=8, Δ=0.96, maxvisits=1000000) =&gt; (visited = (min = 156, mean = 288.515625, max = 496), radius = (min = 95.30998229980469, mean = 235.281365275383, max = 602.959228515625), recall = 0.9109374999999998, searchtime = 5.237203125e-6, conf = BeamSearch(bsize=8, Δ=0.96, maxvisits=1000000))
      BeamSearch(bsize=8, Δ=0.987, maxvisits=1000000) =&gt; (visited = (min = 156, mean = 288.65625, max = 473), radius = (min = 95.30998229980469, mean = 234.9727543592453, max = 602.957763671875), recall = 0.9124999999999999, searchtime = 5.6298125e-6, conf = BeamSearch(bsize=8, Δ=0.987, maxvisits=1000000))
 BeamSearch(bsize=8, Δ=0.97619045, maxvisits=1000000) =&gt; (visited = (min = 156, mean = 288.6875, max = 507), radius = (min = 95.30998229980469, mean = 235.09162318706512, max = 602.959228515625), recall = 0.9124999999999998, searchtime = 2.351621875e-5, conf = BeamSearch(bsize=8, Δ=0.97619045, maxvisits=1000000))
        BeamSearch(bsize=8, Δ=1.0, maxvisits=1000000) =&gt; (visited = (min = 156, mean = 292.9375, max = 475), radius = (min = 95.30998229980469, mean = 232.38708579540253, max = 600.6400146484375), recall = 0.9328124999999997, searchtime = 8.889390625e-6, conf = BeamSearch(bsize=8, Δ=1.0, maxvisits=1000000))
      BeamSearch(bsize=8, Δ=1.008, maxvisits=1000000) =&gt; (visited = (min = 156, mean = 294.890625, max = 479), radius = (min = 95.30998229980469, mean = 232.26638305187225, max = 592.9150390625), recall = 0.9328124999999997, searchtime = 6.0703125e-6, conf = BeamSearch(bsize=8, Δ=1.008, maxvisits=1000000))
       BeamSearch(bsize=8, Δ=1.01, maxvisits=1000000) =&gt; (visited = (min = 156, mean = 295.328125, max = 479), radius = (min = 95.30998229980469, mean = 232.26638305187225, max = 592.9150390625), recall = 0.9328124999999997, searchtime = 6.04140625e-6, conf = BeamSearch(bsize=8, Δ=1.01, maxvisits=1000000))
 BeamSearch(bsize=9, Δ=0.95238096, maxvisits=1000000) =&gt; (visited = (min = 157, mean = 297.15625, max = 497), radius = (min = 95.30998229980469, mean = 235.1863580942154, max = 602.959228515625), recall = 0.9124999999999999, searchtime = 5.5068125e-6, conf = BeamSearch(bsize=9, Δ=0.95238096, maxvisits=1000000))
      BeamSearch(bsize=8, Δ=1.025, maxvisits=1000000) =&gt; (visited = (min = 156, mean = 298.140625, max = 478), radius = (min = 95.30998229980469, mean = 232.26638305187225, max = 592.9150390625), recall = 0.9343749999999997, searchtime = 1.5479171875e-5, conf = BeamSearch(bsize=8, Δ=1.025, maxvisits=1000000))</code></pre>
</div>
</div>
<p>Vamos a buscar en el índice</p>
<div id="42" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@time</span> gknns <span class="op">=</span> <span class="fu">searchbatch</span>(G, gctx, queries, <span class="fl">10</span>)</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  0.468004 seconds (426.38 k allocations: 27.303 MiB, 99.83% compilation time)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>10×100 Matrix{IdWeight}:
 IdWeight(0x0002ba47, 645.508)  …  IdWeight(0x00003d66, 638.768)
 IdWeight(0x0002c399, 658.526)     IdWeight(0x00024c1d, 652.602)
 IdWeight(0x0004d93f, 662.521)     IdWeight(0x00019823, 661.63)
 IdWeight(0x00000ccf, 665.88)      IdWeight(0x00000c37, 664.642)
 IdWeight(0x00015172, 670.139)     IdWeight(0x00022c28, 665.35)
 IdWeight(0x0003512a, 672.902)  …  IdWeight(0x00037352, 666.509)
 IdWeight(0x00004f8b, 675.616)     IdWeight(0x00000ccf, 667.989)
 IdWeight(0x00003f14, 677.731)     IdWeight(0x00041f0f, 668.188)
 IdWeight(0x00003d66, 678.406)     IdWeight(0x0000496d, 669.18)
 IdWeight(0x0003b004, 679.441)     IdWeight(0x0004d93f, 669.351)</code></pre>
</div>
</div>
<p>Vamos observar algunas de las consultas</p>
<div id="44" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> DQ[qID, <span class="op">:</span>]</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(<span class="fu">Dict</span>(<span class="fu">pairs</span>(r)))</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>h.<span class="fu">img</span>(src<span class="op">=</span>r.image_url, alt<span class="op">=</span>r.page_title, width<span class="op">=</span><span class="fl">160</span>)</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>Dict{Symbol, Any} with 19 entries:
  :image_url_sha256                =&gt; "735517acb164c7e062814d36a22d6f90f6dddb3e…
  :ID                              =&gt; String15("00000_0000116")
  :caption_reference_description   =&gt; missing
  :context_section_description     =&gt; "Tipo de Motor: Monocilíndrico, 4 Tiempos…
  :hierarchical_section_title      =&gt; "Suzuki GN 125 / Características"
  :page_url                        =&gt; "https://es.wikipedia.org/wiki/Suzuki_GN_…
  :attribution_passes_lang_id      =&gt; true
  :section_title                   =&gt; "Características"
  :is_main_image                   =&gt; false
  :image_url                       =&gt; "https://upload.wikimedia.org/wikipedia/c…
  :page_title                      =&gt; "Suzuki GN 125"
  :original_width                  =&gt; 1600
  :page_changed_recently           =&gt; true
  :caption_attribution_description =&gt; "Español: Suzuki GN 125"
  :context_page_description        =&gt; "La Suzuki GN 125 es una motocicleta mono…
  :original_height                 =&gt; 1200
  :language                        =&gt; "es"
  :mime_type                       =&gt; String15("image/jpeg")
  :caption_alt_text_description    =&gt; missing</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<img src="https://upload.wikimedia.org/wikipedia/commons/a/a1/Moto_de_Leandro_Lauro%2C_Suzuki_GN_125_H_%282%29.JPG" alt="Suzuki GN 125" width="160">
</div>
</div>
<p>Y sus resultados</p>
<div id="46" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>children <span class="op">=</span> []</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> <span class="fu">view</span>(gknns, <span class="op">:</span>, qID)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  r <span class="op">=</span> D[p.id, [<span class="op">:</span>image_url, <span class="op">:</span>page_url, <span class="op">:</span>page_title]]</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">push!</span>(children,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    h.<span class="fu">div</span>(style<span class="op">=</span><span class="st">"display: inline-block; margin-left: 0.25cm;"</span>,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>      h.<span class="fu">img</span>(src<span class="op">=</span>r.image_url, alt<span class="op">=</span>r.page_title, width<span class="op">=</span><span class="fl">160</span>), h.<span class="fu">br</span>(),</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>      h.<span class="fu">a</span>(r.page_title, href<span class="op">=</span>r.page_url)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> h.<span class="fu">div</span>(children)</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/4/47/Deduction_architecture.png" alt="Sistema axiomático" width="160"><br><a href="https://es.wikipedia.org/wiki/Sistema_axiom%C3%A1tico">Sistema axiomático</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/9/95/Papez_Circuit.jpg" alt="Circuito de Papez" width="160"><br><a href="https://es.wikipedia.org/wiki/Circuito_de_Papez">Circuito de Papez</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="http://upload.wikimedia.org/wikipedia/commons/c/c4/Pattern_4.JPG" alt="Reconocimiento de patrones" width="160"><br><a href="https://es.wikipedia.org/wiki/Reconocimiento_de_patrones">Reconocimiento de patrones</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/0/0b/Piramide_soiusa.png" alt="Sector de subgrupo" width="160"><br><a href="https://es.wikipedia.org/wiki/Sector_de_subgrupo">Sector de subgrupo</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/2/23/Sulfito_Oxidasa_MO1.png" alt="Sulfito oxidasa" width="160"><br><a href="https://es.wikipedia.org/wiki/Sulfito_oxidasa">Sulfito oxidasa</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/d/dc/Nikotinvi%C3%B0takafl%C3%A6%C3%B0irit.png" alt="Agonista nicotínico" width="160"><br><a href="https://es.wikipedia.org/wiki/Agonista_nicot%C3%ADnico">Agonista nicotínico</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/c/c6/Benjam%C3%ADn_Ar%C3%A1oz2.jpg" alt="Benjamín Aráoz" width="160"><br><a href="https://es.wikipedia.org/wiki/Benjam%C3%ADn_Ar%C3%A1oz">Benjamín Aráoz</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="http://upload.wikimedia.org/wikipedia/commons/6/66/Struttura_ndrangheta.jpg" alt="'Ndrangheta" width="160"><br><a href="https://es.wikipedia.org/wiki/%27Ndrangheta">'Ndrangheta</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/f/f6/Organigrama_Orden_de_Agustinos_Recoletos.jpg" alt="Orden de Agustinos Recoletos" width="160"><br><a href="https://es.wikipedia.org/wiki/Orden_de_Agustinos_Recoletos">Orden de Agustinos Recoletos</a></div><div style="display: inline-block; margin-left: 0.25cm;"><img src="https://upload.wikimedia.org/wikipedia/commons/8/87/Garbage_Can_Flows.png" alt="Modelo del bote de basura" width="160"><br><a href="https://es.wikipedia.org/wiki/Modelo_del_bote_de_basura">Modelo del bote de basura</a></div></div>
</div>
</div>
<p>Sus histogramas</p>
<div id="48" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> <span class="fu">plot</span>()</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>p.layout.title.text <span class="op">=</span> <span class="st">"knn distance histogram - indexed - multimodal "</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>p.<span class="fu">histogram</span>(x<span class="op">=</span><span class="fu">convert</span>.(<span class="dt">Float32</span>, <span class="fu">view</span>(gknns, <span class="fl">10</span>, <span class="op">:</span>)))</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<iframe srcdoc="<html><head><meta charset=&quot;utf-8&quot;><meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;><meta name=&quot;description&quot; content=&quot;PlotlyLight.jl Plot&quot;><title>PlotlyLight.jl</title><style>html, body { padding: 0px; margin: 0px; }</style><script src=&quot;https://cdn.plot.ly/plotly-2.35.2.min.js&quot; charset=&quot;utf-8&quot;></script></head><body><div class=&quot;plotlylight-parent&quot;><div class=&quot;plotlylight-plot-div&quot; style=&quot;height:100vh; width:100vw&quot; id=&quot;plotlyx-btvhemeytm&quot;></div><script>Plotly.newPlot(&quot;plotlyx-btvhemeytm&quot;,[{&quot;type&quot;:&quot;histogram&quot;,&quot;x&quot;:[679.4407,678.3507,711.6671,709.41425,692.11365,752.65295,850.7117,802.6644,674.239,690.9885,698.6538,657.399,689.88824,605.11835,677.9861,709.15686,685.75977,709.05615,880.6981,648.51355,658.1951,655.83887,669.08203,679.1405,672.01917,705.6892,718.1301,725.249,719.64636,683.96313,678.7512,673.731,688.47217,656.005,777.7919,714.14966,637.76184,714.6401,773.6693,693.79,679.3611,599.1178,710.9929,689.90314,637.42145,654.70856,726.7604,734.60944,704.7471,833.22943,650.18787,735.8861,809.7765,719.4468,708.27466,760.5875,663.93066,678.5003,667.73865,656.1858,727.07556,778.0418,716.39417,670.3444,680.83594,709.09827,691.61786,683.86255,675.04395,713.1122,812.6361,651.1782,778.1764,731.6599,699.49066,724.7667,685.0769,721.5775,763.36475,650.57245,703.57526,580.5392,691.87775,677.24866,677.44653,630.2395,649.00085,862.78174,682.6684,725.1186,659.56494,738.2461,708.0452,662.6437,662.28015,699.9929,743.5842,681.3279,726.2518,669.3513]}],{&quot;title&quot;:{&quot;text&quot;:&quot;knn distance histogram - indexed - multimodal &quot;}},{&quot;responsive&quot;:true,&quot;displaylogo&quot;:false})</script></div></body></html>" style="display:block; border:none; min-height:350px; min-width:350px; width:100%; height:100%"></iframe>
</div>
</div>
<p>Ahora medimos el recall</p>
<div id="50" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">macrorecall</span>(eknns, gknns)</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>0.13399999999999992</code></pre>
</div>
</div>
<p>Vemos que no es tan bueno, pero es básicamente porque intercambiamos velocidad por calidad. A continuación veremos como mejorar un poco la calidad, manipulando algunos de los parametros de búsqueda.</p>
<div id="52" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>B_ <span class="op">=</span> B <span class="op">=</span> G.algo[]</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="kw">in</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  G.algo[] <span class="op">=</span> B <span class="op">=</span> <span class="fu">BeamSearch</span>(B.bsize, B.Δ, <span class="fl">3</span> <span class="op">*</span> B.maxvisits)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="pp">@time</span> <span class="st">"searching </span><span class="sc">$</span>B<span class="st">"</span> gknns <span class="op">=</span> <span class="fu">searchbatch</span>(G, gctx, queries, <span class="fl">10</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="pp">@info</span> <span class="fu">macrorecall</span>(eknns, gknns)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>G.algo[] <span class="op">=</span> B_</span></code></pre></div><button title="Copiar al portapapeles" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre>searching BeamSearch(bsize=8, Δ=0.93333334, maxvisits=2946): 0.000652 seconds (402 allocations: 19.078 KiB)
<span class="ansi-cyan-fg ansi-bold">[ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>0.13399999999999992
searching BeamSearch(bsize=8, Δ=0.93333334, maxvisits=8838): 0.000524 seconds (402 allocations: 19.078 KiB)
<span class="ansi-cyan-fg ansi-bold">[ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>0.13399999999999992
searching BeamSearch(bsize=8, Δ=0.93333334, maxvisits=26514): 0.000266 seconds (402 allocations: 19.078 KiB)
<span class="ansi-cyan-fg ansi-bold">[ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>0.13399999999999992
searching BeamSearch(bsize=8, Δ=0.93333334, maxvisits=79542): 0.000184 seconds (402 allocations: 19.078 KiB)
<span class="ansi-cyan-fg ansi-bold">[ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>0.13399999999999992
searching BeamSearch(bsize=8, Δ=0.93333334, maxvisits=238626): 0.000180 seconds (402 allocations: 19.078 KiB)
<span class="ansi-cyan-fg ansi-bold">[ </span><span class="ansi-cyan-fg ansi-bold">Info: </span>0.13399999999999992
</pre>
</div>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>BeamSearch(bsize=8, Δ=0.93333334, maxvisits=982)</code></pre>
</div>
</div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copiado");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copiado");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Ejecutar el código</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb49" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="an">engine:</span><span class="co"> julia</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="an">lang:</span><span class="co"> es-MX</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> Búsqueda en espacios métricos</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>Los ejercicios de esta unidad estan en colab <span class="ot">&lt;https://colab.research.google.com/drive/103qHTT_gyOiga8wjsUoWNCB5i__KiOEl?usp=sharing&gt;</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introducción</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>Los algoritmos de búsqueda son centrales en múltiples áreas de las ciencias de la computación; en particular en la recuperación de información.</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>Este problema consiste en identificar rápidamente en una colección objetos que son cercanos a un ejemplo dado, este problema </span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>fue definido con respecto a documentos en la Unidad 2. En la presente unidad se generalizará el concepto.</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>La cercanía o similitud es representada mediante una función de distancia que da una perspectiva _geométrica_ o _espacial_ al problema.</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>Una de las operaciones más importantes en la búsqueda por similitud es la recuperación de $k$ vecinos cercanos que consiste en encontrar</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>los $k$ elementos más cercanos de una base de datos a una consulta dada.</span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>El problema consiste en preprocesar una colección de datos, bajo alguna función de semejanza, para que la identificación de los objetos cercanos a una consulta pueda hacerse en tiempo que no dependa linealmente del tamaño de la colección. En otras palabras, que no sea necesario revisar todos los elementos de la base de datos para responder la consulta. La búsqueda de los $k$-vecinos cercanos tiene aplicaciones en diferentes áreas, como parte operativa de algoritmos de _agrupamiento_ <span class="co">[</span><span class="ot">@SS2021</span><span class="co">]</span> o como parte de la aceleración de dichos algoritmos <span class="co">[</span><span class="ot">@YCC2020; @SKL2011</span><span class="co">]</span>. </span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>En procesamiento de lenguaje natural, la técnica es usada para diferentes objetivos, tal es el caso de recuperación de argumentos <span class="co">[</span><span class="ot">@WPAA2017</span><span class="co">]</span>, descubrimiento de estructuras semánticas <span class="co">[</span><span class="ot">@DS2020</span><span class="co">]</span>, búsqueda semántica <span class="co">[</span><span class="ot">@SPA2019; @FH2017</span><span class="co">]</span>, entre otras. En problemas de clasificación, el método de $k$ vecinos cercanos ha sido usado como uno de los métodos más simples y populares, y a la vez, efectivo <span class="co">[</span><span class="ot">@GCVR2018; @OTGMM2020</span><span class="co">]</span>.</span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>El cálculo de grafos de _todos_ los vecinos cercanos es uno de los componentes de las técnicas de reducción de dimensión no-lineales,</span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>como UMAP <span class="co">[</span><span class="ot">@MHM2018</span><span class="co">]</span>, TriMap <span class="co">[</span><span class="ot">@AW2019</span><span class="co">]</span>, o t-SNE <span class="co">[</span><span class="ot">@VMH2018</span><span class="co">]</span>, además de las alternativas clásicas <span class="co">[</span><span class="ot">@LV2017</span><span class="co">]</span>.</span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>El proceso de reducción de dimensión es usado para incrementar el desempeño de algoritmos de aprendizaje computacional, así como en el proceso de análisis de los datos. Las dimensiones 2 y 3 nos permiten visualizar información de manera efectiva, y por tanto, una proyección fiel en baja dimensión siempre será de utilidad en el proceso de análisis de la información.</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>Una de las partes más costosas del proceso de reducción de dimensión no lineal es la búsqueda de $k$-vecinos cercanos, los algoritmos eficientes de búsqueda de vecinos son fundamentales para obtener en tiempos prácticos información de valor. Así mismo, asegurar la calidad de los vecinos es importante para confiar en las proyecciones que se obtienen.</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a><span class="fu">## Marco teórico</span></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>Una de las formalizaciones más flexibles de búsqueda por similitud consiste en representar el problema en términos de espacios métricos.</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>Un espacio métrico $(U,d)$ esta compuesto de un universo de objetos validos $U$</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>y una función de distancia $d: U \times U \rightarrow \Re^+$.</span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>Para ser precisos, $d$ es una métrica por lo que para todo $u,v,w \in U$</span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>cumple las siguientes propiedades:</span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$d(u, v) \geq 0$ y $d(u,v)= 0 \iff u \equiv v$ (positividad y equivalencia)</span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$d(u, v) = d(v, u)$ (simetría), y finalmente,</span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$d(u, v) + d(v, w)  \leq d(u, w) \leq d(u, v) + d(v, w)$</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>  (desigualdad triangular).</span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>El problema principal de la búsqueda en espacios métricos consiste en,</span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>dado el conjunto finito $S \subseteq U$, deseamos seleccionar elemento parecidos en $S$ a una consulta $q \in U$</span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>bajo una definición consistente de similitud.</span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a><span class="fu">### $k$ vecinos cercanos</span></span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a>Dado un universo de objetos validos $U$ y una función de distancia $d$, y sea $S$ un subconjunto finito de $U$ y dadas la consulta $q \in U$ y el número entero positivo $k$, el objetivo es encontrar $R$ de tamaño $k$ que minimiza $\sum_{u \in R} d(u, q)$, para $R \in 2^S$. Se suele denotar como $k\text{nn}(S, q)$.</span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a>Existe una solución trivial para el problema, que consiste en evaluar $d(q, u)$ para todo $u \in S$.</span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a>Sin embargo, en el caso de interés, i.e., el tamaño de la colección de datos, $n=|S|$, es muy grande y la evaluación exhaustiva de $S$ no escala.</span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a>El problema se complica si adicionalmente la función $d$ es costosa de evaluar computacionalmente, como suele suceder en datos complejos.</span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a>La solución a este problema es indexar o pre-procesar $S$, de tal forma que se evite evaluar la distancia contra la mayor cantidad de elementos de $S$.</span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a><span class="fu">## Sobre la dimensión intrínseca</span></span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a>El modelo de espacios métricos proporciona simplicidad del marco de trabajo, ya que el universo $U$ de objetos puede estar definido  por vectores en cualquier dimensión, secuencias de símbolos, documentos escritos en lenguaje natural, gráficas, distribuciones de probabilidad, o incluso conjuntos de elementos, que a su vez, podrían ser colecciones de los objetos antes mencionados. </span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a>Con la flexibilidad y potencia descrita viene implícita una debilidad, la inherente dependencia en la _dimensionalidad intrínseca_ de los datos, que podemos entenderla de manera informal como la información necesaria que necesita contener o representar un elemento del espacio métrico para ser distinguido entre todos los objetos validos. Chavez et al. <span class="co">[</span><span class="ot">@CNBYM2001</span><span class="co">]</span> detallan una definición formal de la dimensionalidad intrínseca y de como es una generalización de la dimensión de un espacio vectorial. En términos prácticos, la dimensión intrínseca impacta principalmente de dos maneras, en primera instancia suele estar ligada con una función de distancia costosa, y segunda y más importante, destruye la capacidad de discriminación de los índices métricos tal que serán degradados a una evaluación exhaustiva. Lo anterior se debe al efecto que tiene la dimensión sobre la distribución de valores de distancia entre elementos de una colección. De manera más detallada, el aumento de la dimensión trae con sigo el incremento de la distancia mínima entre pares de elementos, y a su vez, la concentración alrededor de la media de las distancias entre objetos. Lo anterior se traduce como la incapacidad de usar la desigualdad del triángulo como filtro.</span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a>Desde el punto de vista del tamaño del conjunto de datos $S$, el problema es evidentemente lineal sin utilizar un índice, ya que basta con evaluar todos los elementos para obtener el resultado exacto. Recientemente se ha probado con diversos formalismos que si la dimensión intrínseca de los datos es _suficientemente_ alta, entonces con _cualquier_ índice posible, la complejidad de la búsqueda sigue siendo lineal en el caso exacto y aún en el caso aproximado. El problema puede reducirse a un  problema NP-completo [@AFN2004], como detalla Hetland [@Hetland2020], quién reduce el problema de búsqueda al problema de _minimum dominating set_, un problema NP-completo clásico. Por otro lado, en 2018 Rubinstein probó que el problema de encontrar el par bicromático mas cercano tiene dureza cuadrática, lo cual implica que la búsqueda del vecino mas cercano tiene a su vez dureza lineal, aún en el sentido aproximado <span class="co">[</span><span class="ot">@RUB2018</span><span class="co">]</span>. Estos resultados, y otros semejantes en la literatura obligan a buscar soluciones de índices sublineales en el sentido probabilístico.</span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a>Para abundar en lo anterior, la búsqueda de proximidad exacta requiere, por ejemplo, encontrar el vecino más cercano _exacto_; mientras que la búsqueda de proximidad aproximada da garantías de proximidad; lo que regresa estará a lo más $\delta$ veces más lejos que el verdadero vecino mas cercano. Los resultados descritos en el párrafo anterior establecen que no es posible crear un índice para cualquiera de estos dos casos. La única posibilidad de tener algoritmos verdaderamente sublineales es en el sentido probabilístico; es decir, _la mayor parte de las veces darán el resultado correcto_; pero cuando se equivocan el error cometido no está acotado.</span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-61"><a href="#cb49-61" aria-hidden="true" tabindex="-1"></a><span class="fu">## Búsqueda aproximada</span></span>
<span id="cb49-62"><a href="#cb49-62" aria-hidden="true" tabindex="-1"></a>Con la finalidad de cuantificar la calidad en el sentido probabilístico, es necesario definir una medida de calidad; en la literatura se puede encontrar que el _recall_ es una medida bien aceptada, y esta definida como sigue:</span>
<span id="cb49-63"><a href="#cb49-63" aria-hidden="true" tabindex="-1"></a>$$recall(S, q, k) = \frac{|k\text{nn}(S, q) \cap k\text{nn}^*(S, q)|}{k}, $$</span>
<span id="cb49-64"><a href="#cb49-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-65"><a href="#cb49-65" aria-hidden="true" tabindex="-1"></a>donde $k$nn calcula los $k$ vecinos de $q$ en $S$ de manera exacta y $k\text{nn}^*$ de manera aproximada, por lo que el valor de _recall_ estará en el rango de 0 a 1, siendo 0 el peor y 1 el mejor.</span>
<span id="cb49-66"><a href="#cb49-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-67"><a href="#cb49-67" aria-hidden="true" tabindex="-1"></a>Se busca que un índice para búsqueda aproximada tenga un costo computacional bajo, i.e., rápido y bajo uso en memoria; y a la vez tenga alta calidad en su aproximación, i.e., _recall_ cercano a 1. Claramente, los objetivos se contraponen y es necesario encontrar los métodos que mejor se ajusten a las necesidades del problema a solucionar.</span>
<span id="cb49-68"><a href="#cb49-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-69"><a href="#cb49-69" aria-hidden="true" tabindex="-1"></a><span class="fu">## Esquemas de búsqueda de $k$-vecinos cercanos en gráficas</span></span>
<span id="cb49-70"><a href="#cb49-70" aria-hidden="true" tabindex="-1"></a>En <span class="co">[</span><span class="ot">@GLS2008</span><span class="co">]</span> se transforma el problema de búsqueda en espacios métricos al problema de navegación en una gráfica dónde los vértices representan al conjunto de datos y las aristas conexiones pesadas por un esquema especial de desorden con respecto a los vértices. Para resolver consultas se toma un vértice como inicio e iterativamente se reduce la distancia de los nodos visitados a la consulta. Este trabajo tiene un valor teórico importante, sin embargo, es poco útil en la práctica dados los costos computacionales envueltos en la construcción de la gráfica, sobre todo su memoria cuadrática.</span>
<span id="cb49-71"><a href="#cb49-71" aria-hidden="true" tabindex="-1"></a>Chavez y Téllez <span class="co">[</span><span class="ot">@CT2010</span><span class="co">]</span> estudian una gráfica navegable inducida por la gráfica de todos los vecinos cercanos, tanto directos como reversos y describen como manejar las componentes dentro de la misma. Este algoritmo requiere la construcción de la gráfica de todos los $k$ vecinos cercanos, por lo que su construcción es muy costosa. Un algoritmo alternativo con un uso más reducido de memoria y construcciones más eficientes es el {\em Rank Cover Tree} (RCT) <span class="co">[</span><span class="ot">@HN2014</span><span class="co">]</span>. En lugar de la construcción genérica de una gráfica, se crea un árbol, con un nodo raíz que siempre será usado para iniciar la búsqueda. Los nodos descendientes se obtienen por rango, i.e., orden al padre, y es la única información que se usa para la navegación. El grado de cada nodo es un parámetro que limita los requerimientos de memoria y el costo de las búsquedas, en intercambio con la calidad de los resultados.</span>
<span id="cb49-72"><a href="#cb49-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-73"><a href="#cb49-73" aria-hidden="true" tabindex="-1"></a>En Malkov et al. <span class="co">[</span><span class="ot">@MPLK2014</span><span class="co">]</span> se introduce el índice _Navigable Small World_ (NSW), un esquema novedoso con un desempeño notable.</span>
<span id="cb49-74"><a href="#cb49-74" aria-hidden="true" tabindex="-1"></a>Dichos autores sugieren que la velocidad de búsqueda y precisión de NSW se debe a que su algoritmo de construcción captura las propiedades de _Mundo Pequeño_ (_Small World_) de una base de datos métrica.</span>
<span id="cb49-75"><a href="#cb49-75" aria-hidden="true" tabindex="-1"></a>Los requerimientos computacionales del NSW para su funcionamiento óptimo y el tiempo de construcción son altos, pero muy por debajo de esquemas anteriores.</span>
<span id="cb49-76"><a href="#cb49-76" aria-hidden="true" tabindex="-1"></a>La construcción de NSW es incremental, se inserta un elemento a la vez, el algoritmo consiste en conectar el $j$-ésimo elemento con sus $k$ vecinos cercanos aproximados tomados en los $j-1$ elementos previamente indexados.</span>
<span id="cb49-77"><a href="#cb49-77" aria-hidden="true" tabindex="-1"></a>Las conexiones son no-dirigidas, por lo que el grafo resultante también es no-dirigido.</span>
<span id="cb49-78"><a href="#cb49-78" aria-hidden="true" tabindex="-1"></a>El orden de inserción debe ser aleatorizado para evitar varios casos con muy mal desempeño.</span>
<span id="cb49-79"><a href="#cb49-79" aria-hidden="true" tabindex="-1"></a>Finalmente, el número de vecinos, $k$, es un parámetro crucial que debe ser optimizado para cada base de datos. En <span class="co">[</span><span class="ot">@MYD2018</span><span class="co">]</span> se introduce una variante aún más veloz que consisten en una estructura jerárquica sobre la gráfica NSW; éste nuevo algoritmo reduce los peores casos y es capaz de reducir la memoria necesaria por la gráfica usando una selección más apropiada de las aristas que conectan los vértices.</span>
<span id="cb49-80"><a href="#cb49-80" aria-hidden="true" tabindex="-1"></a>Ruiz et al. <span class="co">[</span><span class="ot">@RCGT2015</span><span class="co">]</span> introducen nuevos algoritmos para la navegación del NSW, los cuales son capaces de obtener resultados de mayor calidad a igualdad de memoria. Mas recientemente, Tellez et al. <span class="co">[</span><span class="ot">@TRCG2021</span><span class="co">]</span> presentan estrategias para calcular el grado de los vértices, y así mismo, de filtrado de los vértices que dan como resultado búsquedas más eficientes y gráficas más pequeñas.</span>
<span id="cb49-81"><a href="#cb49-81" aria-hidden="true" tabindex="-1"></a>Dada la definición del NSW, la gráfica guarda información útil sobre la estructura de la colección de datos siendo representada, que hasta el momento ha sido poco explotada.</span>
<span id="cb49-82"><a href="#cb49-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-83"><a href="#cb49-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-84"><a href="#cb49-84" aria-hidden="true" tabindex="-1"></a><span class="fu"># Bibliografía</span></span>
<span id="cb49-85"><a href="#cb49-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-86"><a href="#cb49-86" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@AFN2004</span><span class="co">]</span> Alber, J., Fellows, M. R., &amp; Niedermeier, R. (2004). Polynomial-time data reduction for dominating set. Journal of the ACM (JACM), 51(3), 363-384.</span>
<span id="cb49-87"><a href="#cb49-87" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@AW2019</span><span class="co">]</span> Amid, E., &amp; Warmuth, M. K. (2019). TriMap: Large-scale dimensionality reduction using triplets. arXiv preprint arXiv:1910.00204.</span>
<span id="cb49-88"><a href="#cb49-88" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@CNBYM2001</span><span class="co">]</span> Chávez, E., Navarro, G., Baeza-Yates, R., &amp; Marroquín, J. L. (2001). Searching in metric spaces. ACM computing surveys (CSUR), 33(3), 273-321.</span>
<span id="cb49-89"><a href="#cb49-89" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@CT2010</span><span class="co">]</span> Chávez, E., &amp; Tellez, E. S. (2010, September). Navigating k-nearest neighbor graphs to solve nearest neighbor searches. In Mexican Conference on Pattern Recognition (pp. 270-280). Springer, Berlin, Heidelberg.</span>
<span id="cb49-90"><a href="#cb49-90" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@DS2020</span><span class="co">]</span> DS, D. (2020). A simple solution for the taxonomy enrichment task: Discovering hypernyms using nearest neighbor search.</span>
<span id="cb49-91"><a href="#cb49-91" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@FH2017</span><span class="co">]</span> Faessler, E., &amp; Hahn, U. (2017, July). Semedico: a comprehensive semantic search engine for the life sciences. In Proceedings of ACL 2017, System Demonstrations (pp. 91-96).</span>
<span id="cb49-92"><a href="#cb49-92" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@GCVR2018</span><span class="co">]</span> Gallego, A. J., Calvo-Zaragoza, J., Valero-Mas, J. J., &amp; Rico-Juan, J. R. (2018). Clustering-based k-nearest neighbor classification for large-scale data with neural codes representation. Pattern Recognition, 74, 531-543.</span>
<span id="cb49-93"><a href="#cb49-93" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@GLS2008</span><span class="co">]</span> Goyal, N., Lifshits, Y., &amp; Schütze, H. (2008, February). Disorder inequality: a combinatorial approach to nearest neighbor search. In Proceedings of the 2008 international conference on web search and data mining (pp. 25-32).</span>
<span id="cb49-94"><a href="#cb49-94" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@HN2014</span><span class="co">]</span> Houle, M. E., &amp; Nett, M. (2014). Rank-based similarity search: Reducing the dimensional dependence. IEEE transactions on pattern analysis and machine intelligence, 37(1), 136-150.</span>
<span id="cb49-95"><a href="#cb49-95" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@Hetland2020</span><span class="co">]</span> Hetland, M. L. (2020, September). Optimal Metric Search Is Equivalent to the Minimum Dominating Set Problem. In International Conference on Similarity Search and Applications (pp. 111-125). Springer, Cham.</span>
<span id="cb49-96"><a href="#cb49-96" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@LV2017</span><span class="co">]</span> Lee, J. A., &amp; Verleysen, M. (2007). Nonlinear dimensionality reduction (Vol. 1). New York: Springer.</span>
<span id="cb49-97"><a href="#cb49-97" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@MHM2018</span><span class="co">]</span> McInnes, L., Healy, J., &amp; Melville, J. (2018). Umap: Uniform manifold approximation and projection for dimension reduction. arXiv preprint arXiv:1802.03426.</span>
<span id="cb49-98"><a href="#cb49-98" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@MPLK2014</span><span class="co">]</span> Malkov, Y., Ponomarenko, A., Logvinov, A., &amp; Krylov, V. (2014). Approximate nearest neighbor algorithm based on navigable small world graphs. Information Systems, 45, 61-68.</span>
<span id="cb49-99"><a href="#cb49-99" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@MYD2018</span><span class="co">]</span> Malkov, Y. A., &amp; Yashunin, D. A. (2018). Efficient and robust approximate nearest neighbor search using hierarchical navigable small world graphs. IEEE transactions on pattern analysis and machine intelligence, 42(4), 824-836.</span>
<span id="cb49-100"><a href="#cb49-100" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@OTGMM2020</span><span class="co">]</span> Ortiz-Bejar, J., Téllez, E. S., Graff, M., Moctezuma, D., &amp; Miranda-Jiménez, S. (2020). Improving k Nearest Neighbors and Naïve Bayes Classifiers Through Space Transformations and Model Selection. IEEE Access, 8, 221669-221688.</span>
<span id="cb49-101"><a href="#cb49-101" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@RCGT2015</span><span class="co">]</span> Ruiz, G., Chávez, E., Graff, M., &amp; Téllez, E. S. (2015, October). Finding near neighbors through local search. In International Conference on Similarity Search and Applications (pp. 103-109). Springer, Cham.</span>
<span id="cb49-102"><a href="#cb49-102" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@RUB2018</span><span class="co">]</span> Rubinstein, A. (2018, June). Hardness of approximate nearest neighbor search. In Proceedings of the 50th annual ACM SIGACT symposium on theory of computing (pp. 1260-1268).</span>
<span id="cb49-103"><a href="#cb49-103" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@SKL2011</span><span class="co">]</span> Pedregosa, F., Varoquaux, G., Gramfort, A., Michel, V., Thirion, B., Grisel, O., ... &amp; Duchesnay, E. (2011). Scikit-learn: Machine learning in Python. the Journal of machine Learning research, 12, 2825-2830.</span>
<span id="cb49-104"><a href="#cb49-104" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@SPA2019</span><span class="co">]</span> Soto, A. J., Przybyła, P., &amp; Ananiadou, S. (2019). Thalia: semantic search engine for biomedical abstracts. Bioinformatics, 35(10), 1799-1801.</span>
<span id="cb49-105"><a href="#cb49-105" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@SS2021</span><span class="co">]</span> Sharma, K. K., &amp; Seal, A. (2021). Spectral embedded generalized mean based k-nearest neighbors clustering with S-distance. Expert Systems with Applications, 169, 114326.</span>
<span id="cb49-106"><a href="#cb49-106" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@TR2022</span><span class="co">]</span> Tellez, E. S., &amp; Ruiz, G. (2022). Similarity search on neighbor's graphs with automatic Pareto optimal performance and minimum expected quality setups based on hyperparameter optimization. arXiv preprint arXiv:2201.07917.</span>
<span id="cb49-107"><a href="#cb49-107" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@TRCG2021</span><span class="co">]</span> Tellez, E. S., Ruiz, G., Chavez, E., &amp; Graff, M. (2021). A scalable solution to the nearest neighbor search problem through local-search methods on neighbor graphs. Pattern Analysis and Applications, 24(2), 763-777.</span>
<span id="cb49-108"><a href="#cb49-108" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@VMH2018</span><span class="co">]</span> Van der Maaten, L., &amp; Hinton, G. (2008). Visualizing data using t-SNE. Journal of machine learning research, 9(11).</span>
<span id="cb49-109"><a href="#cb49-109" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@WPAA2017</span><span class="co">]</span> Wachsmuth, H., Potthast, M., Al Khatib, K., Ajjour, Y., Puschmann, J., Qu, J., ... &amp; Stein, B. (2017, September). Building an argument search engine for the web. In Proceedings of the 4th Workshop on Argument Mining (pp. 49-59).</span>
<span id="cb49-110"><a href="#cb49-110" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">@YCC2020</span><span class="co">]</span> Yu, Q., Chen, K. H., &amp; Chen, J. J. (2020, September). Using a set of triangle inequalities to accelerate k-means clustering. In International Conference on Similarity Search and Applications (pp. 297-311). Springer, Cham.</span>
<span id="cb49-111"><a href="#cb49-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-112"><a href="#cb49-112" aria-hidden="true" tabindex="-1"></a><span class="fu">## Ejemplo de uso con `SimilaritySearch`</span></span>
<span id="cb49-115"><a href="#cb49-115" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-116"><a href="#cb49-116" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">CSV</span>, <span class="bu">DataFrames</span></span>
<span id="cb49-117"><a href="#cb49-117" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">SimilaritySearch</span>, <span class="bu">StatsBase</span></span>
<span id="cb49-118"><a href="#cb49-118" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">PlotlyLight</span>, <span class="bu">JSON3</span>, <span class="bu">Cobweb</span></span>
<span id="cb49-119"><a href="#cb49-119" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">LinearAlgebra</span>, <span class="bu">HDF5</span></span>
<span id="cb49-120"><a href="#cb49-120" aria-hidden="true" tabindex="-1"></a>PlotlyLight.settings.use_iframe <span class="op">=</span> <span class="cn">true</span>  <span class="co"># necesario para quarto / jupyter / etc.</span></span>
<span id="cb49-121"><a href="#cb49-121" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-122"><a href="#cb49-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-123"><a href="#cb49-123" aria-hidden="true" tabindex="-1"></a><span class="fu">### Descargando los datos</span></span>
<span id="cb49-124"><a href="#cb49-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-125"><a href="#cb49-125" aria-hidden="true" tabindex="-1"></a>Para estos ejemplos, estaremos usando el segmento de Español de la base de datos Wikipedia Image-Text (WIT); previamente se calcularon los encajes de las imágenes y el texto usando el modelo Jina CLIP v2 <span class="ot">&lt;https://huggingface.co/jinaai/jina-clip-v2&gt;</span>.</span>
<span id="cb49-126"><a href="#cb49-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-129"><a href="#cb49-129" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-130"><a href="#cb49-130" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> <span class="st">"WIT-es_jina-clip-v2_sample"</span></span>
<span id="cb49-131"><a href="#cb49-131" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> !<span class="fu">isdir</span>(path)</span>
<span id="cb49-132"><a href="#cb49-132" aria-hidden="true" tabindex="-1"></a>  <span class="fu">run</span>(<span class="ss">`git clone https://huggingface.co/datasets/sadit/WIT-es_jina-clip-v2_sample/`</span>)</span>
<span id="cb49-133"><a href="#cb49-133" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb49-134"><a href="#cb49-134" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-135"><a href="#cb49-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-136"><a href="#cb49-136" aria-hidden="true" tabindex="-1"></a>La lectura de la base de datos vectorial se realizará con HDF5</span>
<span id="cb49-139"><a href="#cb49-139" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-140"><a href="#cb49-140" aria-hidden="true" tabindex="-1"></a>metaimages <span class="op">=</span> <span class="st">"</span><span class="sc">$</span>path<span class="st">/es-wit-images.tsv"</span></span>
<span id="cb49-141"><a href="#cb49-141" aria-hidden="true" tabindex="-1"></a>vecimages <span class="op">=</span> <span class="st">"</span><span class="sc">$</span>path<span class="st">/es-wit-images.h5"</span></span>
<span id="cb49-142"><a href="#cb49-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-143"><a href="#cb49-143" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> <span class="fu">Matrix</span><span class="dt">{Float16}</span>(<span class="fu">h5read</span>(vecimages, <span class="st">"emb"</span>))</span>
<span id="cb49-144"><a href="#cb49-144" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-145"><a href="#cb49-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-146"><a href="#cb49-146" aria-hidden="true" tabindex="-1"></a>En particular, se convirtió a números de punto flotante de precisión media; solo los procesadores más nuevos le sacan provecho a estas representaciones en SIMD, pero en cualquier caso nos sirve para mantener la base de datos en un tamaño razonable.</span>
<span id="cb49-147"><a href="#cb49-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-148"><a href="#cb49-148" aria-hidden="true" tabindex="-1"></a>Ahora leemos los metadatos</span>
<span id="cb49-151"><a href="#cb49-151" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-152"><a href="#cb49-152" aria-hidden="true" tabindex="-1"></a>D <span class="op">=</span> CSV.<span class="fu">read</span>(metaimages, DataFrame)</span>
<span id="cb49-153"><a href="#cb49-153" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(<span class="fu">names</span>(D))</span>
<span id="cb49-154"><a href="#cb49-154" aria-hidden="true" tabindex="-1"></a><span class="fu">Dict</span>(<span class="fu">pairs</span>(D[<span class="fl">1</span>, <span class="op">:</span>]))</span>
<span id="cb49-155"><a href="#cb49-155" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-156"><a href="#cb49-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-157"><a href="#cb49-157" aria-hidden="true" tabindex="-1"></a><span class="fu">## Búsqueda por fuerza bruta en imágenes</span></span>
<span id="cb49-158"><a href="#cb49-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-159"><a href="#cb49-159" aria-hidden="true" tabindex="-1"></a>Usando subconjuntos pequeños de la base de datos leída (Embeddings de imágenes con Jina CLIP v2), vamos a realizar algunas búsquedas.</span>
<span id="cb49-162"><a href="#cb49-162" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-163"><a href="#cb49-163" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fl">4</span></span>
<span id="cb49-164"><a href="#cb49-164" aria-hidden="true" tabindex="-1"></a>db, queries <span class="op">=</span> <span class="fu">MatrixDatabase</span>(X[<span class="op">:</span>, <span class="fl">1</span><span class="op">:</span>n]), <span class="fu">MatrixDatabase</span>(X[<span class="op">:</span>, n<span class="op">+</span><span class="fl">1</span><span class="op">:</span>n<span class="op">+</span><span class="fl">100</span>])</span>
<span id="cb49-165"><a href="#cb49-165" aria-hidden="true" tabindex="-1"></a>dist <span class="op">=</span> <span class="fu">SqL2_asf32</span>()</span>
<span id="cb49-166"><a href="#cb49-166" aria-hidden="true" tabindex="-1"></a>S <span class="op">=</span> <span class="fu">ExhaustiveSearch</span>(; db, dist)</span>
<span id="cb49-167"><a href="#cb49-167" aria-hidden="true" tabindex="-1"></a>ctx <span class="op">=</span> <span class="fu">GenericContext</span>()</span>
<span id="cb49-168"><a href="#cb49-168" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-169"><a href="#cb49-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-170"><a href="#cb49-170" aria-hidden="true" tabindex="-1"></a>Ahora las búsquedas</span>
<span id="cb49-173"><a href="#cb49-173" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-174"><a href="#cb49-174" aria-hidden="true" tabindex="-1"></a>knns <span class="op">=</span> <span class="fu">searchbatch</span>(S, ctx, queries, <span class="fl">10</span>)</span>
<span id="cb49-175"><a href="#cb49-175" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-176"><a href="#cb49-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-177"><a href="#cb49-177" aria-hidden="true" tabindex="-1"></a>Podemos observar a que corresponde una de las consultas realizadas</span>
<span id="cb49-180"><a href="#cb49-180" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-181"><a href="#cb49-181" aria-hidden="true" tabindex="-1"></a>qID <span class="op">=</span> <span class="fl">100</span></span>
<span id="cb49-182"><a href="#cb49-182" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> D[<span class="fl">10_000</span> <span class="op">+</span> qID, <span class="op">:</span>]</span>
<span id="cb49-183"><a href="#cb49-183" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(<span class="fu">Dict</span>(<span class="fu">pairs</span>(r)))</span>
<span id="cb49-184"><a href="#cb49-184" aria-hidden="true" tabindex="-1"></a>h.<span class="fu">img</span>(src<span class="op">=</span>r.image_url, alt<span class="op">=</span>r.page_title, width<span class="op">=</span><span class="fl">160</span>)</span>
<span id="cb49-185"><a href="#cb49-185" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-186"><a href="#cb49-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-187"><a href="#cb49-187" aria-hidden="true" tabindex="-1"></a>Ahora las respuestas</span>
<span id="cb49-190"><a href="#cb49-190" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-191"><a href="#cb49-191" aria-hidden="true" tabindex="-1"></a>children <span class="op">=</span> []</span>
<span id="cb49-192"><a href="#cb49-192" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> <span class="fu">view</span>(knns, <span class="op">:</span>, qID)</span>
<span id="cb49-193"><a href="#cb49-193" aria-hidden="true" tabindex="-1"></a>  r <span class="op">=</span> D[p.id, [<span class="op">:</span>image_url, <span class="op">:</span>page_url, <span class="op">:</span>page_title]]</span>
<span id="cb49-194"><a href="#cb49-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">push!</span>(children,</span>
<span id="cb49-195"><a href="#cb49-195" aria-hidden="true" tabindex="-1"></a>    h.<span class="fu">div</span>(style<span class="op">=</span><span class="st">"display: inline-block; margin-left: 0.25cm;"</span>,</span>
<span id="cb49-196"><a href="#cb49-196" aria-hidden="true" tabindex="-1"></a>      h.<span class="fu">img</span>(src<span class="op">=</span>r.image_url, alt<span class="op">=</span>r.page_title, width<span class="op">=</span><span class="fl">160</span>), h.<span class="fu">br</span>(),</span>
<span id="cb49-197"><a href="#cb49-197" aria-hidden="true" tabindex="-1"></a>      h.<span class="fu">a</span>(r.page_title, href<span class="op">=</span>r.page_url)</span>
<span id="cb49-198"><a href="#cb49-198" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-199"><a href="#cb49-199" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb49-200"><a href="#cb49-200" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb49-201"><a href="#cb49-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-202"><a href="#cb49-202" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> h.<span class="fu">div</span>(children)</span>
<span id="cb49-203"><a href="#cb49-203" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-204"><a href="#cb49-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-205"><a href="#cb49-205" aria-hidden="true" tabindex="-1"></a>A continuación se muestran el histograma de distancias del 10-ésimo vecino cercano.</span>
<span id="cb49-208"><a href="#cb49-208" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-209"><a href="#cb49-209" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> <span class="fu">plot</span>()</span>
<span id="cb49-210"><a href="#cb49-210" aria-hidden="true" tabindex="-1"></a><span class="co">#p = plot(x = 1:20, y = cumsum(randn(20)), type="scatter", mode="lines+markers")  # Make plot</span></span>
<span id="cb49-211"><a href="#cb49-211" aria-hidden="true" tabindex="-1"></a>p.layout.title.text <span class="op">=</span> <span class="st">"knn distance histogram"</span></span>
<span id="cb49-212"><a href="#cb49-212" aria-hidden="true" tabindex="-1"></a>p.<span class="fu">histogram</span>(x<span class="op">=</span><span class="fu">convert</span>.(<span class="dt">Float32</span>, <span class="fu">view</span>(knns, <span class="fl">10</span>, <span class="op">:</span>)))</span>
<span id="cb49-213"><a href="#cb49-213" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-214"><a href="#cb49-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-215"><a href="#cb49-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-216"><a href="#cb49-216" aria-hidden="true" tabindex="-1"></a><span class="fu">## Búsqueda con Texto - Embeddings de Jina Clip v2</span></span>
<span id="cb49-217"><a href="#cb49-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-218"><a href="#cb49-218" aria-hidden="true" tabindex="-1"></a>Ahora vamos a realizar las búsquedas en la modalidad de texto, usando nuevamente los embeddings de Jina CLIP v2.</span>
<span id="cb49-219"><a href="#cb49-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-220"><a href="#cb49-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-223"><a href="#cb49-223" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-224"><a href="#cb49-224" aria-hidden="true" tabindex="-1"></a>metatext <span class="op">=</span> <span class="st">"</span><span class="sc">$</span>path<span class="st">/es-wit-text.tsv"</span></span>
<span id="cb49-225"><a href="#cb49-225" aria-hidden="true" tabindex="-1"></a>vectext <span class="op">=</span> <span class="st">"</span><span class="sc">$</span>path<span class="st">/es-wit-text.h5"</span></span>
<span id="cb49-226"><a href="#cb49-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-227"><a href="#cb49-227" aria-hidden="true" tabindex="-1"></a>Q <span class="op">=</span> <span class="fu">Matrix</span><span class="dt">{Float16}</span>(<span class="fu">h5read</span>(vectext, <span class="st">"emb"</span>))</span>
<span id="cb49-228"><a href="#cb49-228" aria-hidden="true" tabindex="-1"></a>DQ <span class="op">=</span> CSV.<span class="fu">read</span>(metatext, DataFrame)</span>
<span id="cb49-229"><a href="#cb49-229" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(DQ)</span>
<span id="cb49-230"><a href="#cb49-230" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-231"><a href="#cb49-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-232"><a href="#cb49-232" aria-hidden="true" tabindex="-1"></a>Indexaremos un pequeño segmento</span>
<span id="cb49-235"><a href="#cb49-235" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-236"><a href="#cb49-236" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="fl">4</span></span>
<span id="cb49-237"><a href="#cb49-237" aria-hidden="true" tabindex="-1"></a>db, queries <span class="op">=</span> <span class="fu">MatrixDatabase</span>(Q[<span class="op">:</span>, <span class="fl">1</span><span class="op">:</span>n]), <span class="fu">MatrixDatabase</span>(Q[<span class="op">:</span>, n<span class="op">+</span><span class="fl">1</span><span class="op">:</span>n<span class="op">+</span><span class="fl">100</span>])</span>
<span id="cb49-238"><a href="#cb49-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-239"><a href="#cb49-239" aria-hidden="true" tabindex="-1"></a>S <span class="op">=</span> <span class="fu">ExhaustiveSearch</span>(; db, dist)</span>
<span id="cb49-240"><a href="#cb49-240" aria-hidden="true" tabindex="-1"></a>knns <span class="op">=</span> <span class="fu">searchbatch</span>(S, ctx, queries, <span class="fl">10</span>)</span>
<span id="cb49-241"><a href="#cb49-241" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-242"><a href="#cb49-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-243"><a href="#cb49-243" aria-hidden="true" tabindex="-1"></a>Ahora veremos una de las consultas</span>
<span id="cb49-246"><a href="#cb49-246" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-247"><a href="#cb49-247" aria-hidden="true" tabindex="-1"></a>qID <span class="op">=</span> <span class="fl">100</span></span>
<span id="cb49-248"><a href="#cb49-248" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> DQ[<span class="fl">10_000</span> <span class="op">+</span> qID, <span class="op">:</span>]</span>
<span id="cb49-249"><a href="#cb49-249" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(<span class="fu">Dict</span>(<span class="fu">pairs</span>(r)))</span>
<span id="cb49-250"><a href="#cb49-250" aria-hidden="true" tabindex="-1"></a>h.<span class="fu">img</span>(src<span class="op">=</span>r.image_url, alt<span class="op">=</span>r.page_title, width<span class="op">=</span><span class="fl">160</span>)</span>
<span id="cb49-251"><a href="#cb49-251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-252"><a href="#cb49-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-253"><a href="#cb49-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-254"><a href="#cb49-254" aria-hidden="true" tabindex="-1"></a>y los resultados asociados</span>
<span id="cb49-257"><a href="#cb49-257" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-258"><a href="#cb49-258" aria-hidden="true" tabindex="-1"></a>children <span class="op">=</span> []</span>
<span id="cb49-259"><a href="#cb49-259" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> <span class="fu">view</span>(knns, <span class="op">:</span>, qID)</span>
<span id="cb49-260"><a href="#cb49-260" aria-hidden="true" tabindex="-1"></a>  r <span class="op">=</span> DQ[p.id, [<span class="op">:</span>image_url, <span class="op">:</span>page_url, <span class="op">:</span>page_title]]</span>
<span id="cb49-261"><a href="#cb49-261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">push!</span>(children,</span>
<span id="cb49-262"><a href="#cb49-262" aria-hidden="true" tabindex="-1"></a>    h.<span class="fu">div</span>(style<span class="op">=</span><span class="st">"display: inline-block; margin-left: 0.25cm;"</span>,</span>
<span id="cb49-263"><a href="#cb49-263" aria-hidden="true" tabindex="-1"></a>      h.<span class="fu">img</span>(src<span class="op">=</span>r.image_url, alt<span class="op">=</span>r.page_title, width<span class="op">=</span><span class="fl">160</span>), h.<span class="fu">br</span>(),</span>
<span id="cb49-264"><a href="#cb49-264" aria-hidden="true" tabindex="-1"></a>      h.<span class="fu">a</span>(r.page_title, href<span class="op">=</span>r.page_url)</span>
<span id="cb49-265"><a href="#cb49-265" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-266"><a href="#cb49-266" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb49-267"><a href="#cb49-267" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb49-268"><a href="#cb49-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-269"><a href="#cb49-269" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> h.<span class="fu">div</span>(children)</span>
<span id="cb49-270"><a href="#cb49-270" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-271"><a href="#cb49-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-272"><a href="#cb49-272" aria-hidden="true" tabindex="-1"></a>Observemos el histograma de distancias</span>
<span id="cb49-275"><a href="#cb49-275" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-276"><a href="#cb49-276" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> <span class="fu">plot</span>()</span>
<span id="cb49-277"><a href="#cb49-277" aria-hidden="true" tabindex="-1"></a>p.layout.title.text <span class="op">=</span> <span class="st">"knn distance histogram - text "</span></span>
<span id="cb49-278"><a href="#cb49-278" aria-hidden="true" tabindex="-1"></a>p.<span class="fu">histogram</span>(x<span class="op">=</span><span class="fu">convert</span>.(<span class="dt">Float32</span>, <span class="fu">view</span>(knns, <span class="fl">10</span>, <span class="op">:</span>)))</span>
<span id="cb49-279"><a href="#cb49-279" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-280"><a href="#cb49-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-281"><a href="#cb49-281" aria-hidden="true" tabindex="-1"></a>Comparemos con el de imágenes que anteriormente calculamos.</span>
<span id="cb49-282"><a href="#cb49-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-283"><a href="#cb49-283" aria-hidden="true" tabindex="-1"></a><span class="fu">## Búsqueda Multimodal</span></span>
<span id="cb49-284"><a href="#cb49-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-285"><a href="#cb49-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-286"><a href="#cb49-286" aria-hidden="true" tabindex="-1"></a>Finalizaremos con búsqueda multimodal, con más datos</span>
<span id="cb49-289"><a href="#cb49-289" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-290"><a href="#cb49-290" aria-hidden="true" tabindex="-1"></a>db, queries <span class="op">=</span> <span class="fu">MatrixDatabase</span>(X), <span class="fu">MatrixDatabase</span>(Q[<span class="op">:</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">100</span>])</span>
<span id="cb49-291"><a href="#cb49-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-292"><a href="#cb49-292" aria-hidden="true" tabindex="-1"></a>S <span class="op">=</span> <span class="fu">ExhaustiveSearch</span>(; db, dist)</span>
<span id="cb49-293"><a href="#cb49-293" aria-hidden="true" tabindex="-1"></a><span class="pp">@time</span> eknns <span class="op">=</span> <span class="fu">searchbatch</span>(S, ctx, queries, <span class="fl">10</span>)</span>
<span id="cb49-294"><a href="#cb49-294" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-295"><a href="#cb49-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-296"><a href="#cb49-296" aria-hidden="true" tabindex="-1"></a>En este momento tenemos el conjunto de resultados <span class="in">`eknns`</span>, el cual fue generado con una búsqueda exacta. Observa los tiempos.</span>
<span id="cb49-297"><a href="#cb49-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-298"><a href="#cb49-298" aria-hidden="true" tabindex="-1"></a>Ahora veamos una de las consultas</span>
<span id="cb49-301"><a href="#cb49-301" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-302"><a href="#cb49-302" aria-hidden="true" tabindex="-1"></a>qID <span class="op">=</span> <span class="fl">7</span></span>
<span id="cb49-303"><a href="#cb49-303" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> DQ[qID, <span class="op">:</span>]</span>
<span id="cb49-304"><a href="#cb49-304" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(<span class="fu">Dict</span>(<span class="fu">pairs</span>(r)))</span>
<span id="cb49-305"><a href="#cb49-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-306"><a href="#cb49-306" aria-hidden="true" tabindex="-1"></a>h.<span class="fu">img</span>(src<span class="op">=</span>r.image_url, alt<span class="op">=</span>r.page_title, width<span class="op">=</span><span class="fl">160</span>)</span>
<span id="cb49-307"><a href="#cb49-307" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-308"><a href="#cb49-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-309"><a href="#cb49-309" aria-hidden="true" tabindex="-1"></a>Y sus respectivas respuestas</span>
<span id="cb49-312"><a href="#cb49-312" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-313"><a href="#cb49-313" aria-hidden="true" tabindex="-1"></a>children <span class="op">=</span> []</span>
<span id="cb49-314"><a href="#cb49-314" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> <span class="fu">view</span>(eknns, <span class="op">:</span>, qID)</span>
<span id="cb49-315"><a href="#cb49-315" aria-hidden="true" tabindex="-1"></a>  r <span class="op">=</span> D[p.id, [<span class="op">:</span>image_url, <span class="op">:</span>page_url, <span class="op">:</span>page_title]]</span>
<span id="cb49-316"><a href="#cb49-316" aria-hidden="true" tabindex="-1"></a>  <span class="fu">push!</span>(children,</span>
<span id="cb49-317"><a href="#cb49-317" aria-hidden="true" tabindex="-1"></a>    h.<span class="fu">div</span>(style<span class="op">=</span><span class="st">"display: inline-block; margin-left: 0.25cm;"</span>,</span>
<span id="cb49-318"><a href="#cb49-318" aria-hidden="true" tabindex="-1"></a>      h.<span class="fu">img</span>(src<span class="op">=</span>r.image_url, alt<span class="op">=</span>r.page_title, width<span class="op">=</span><span class="fl">160</span>), h.<span class="fu">br</span>(),</span>
<span id="cb49-319"><a href="#cb49-319" aria-hidden="true" tabindex="-1"></a>      h.<span class="fu">a</span>(r.page_title, href<span class="op">=</span>r.page_url)</span>
<span id="cb49-320"><a href="#cb49-320" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-321"><a href="#cb49-321" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb49-322"><a href="#cb49-322" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb49-323"><a href="#cb49-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-324"><a href="#cb49-324" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> h.<span class="fu">div</span>(children)</span>
<span id="cb49-325"><a href="#cb49-325" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-326"><a href="#cb49-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-327"><a href="#cb49-327" aria-hidden="true" tabindex="-1"></a>Observemos el histograma de distancias y compare con los histogramas pasados.</span>
<span id="cb49-330"><a href="#cb49-330" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-331"><a href="#cb49-331" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> <span class="fu">plot</span>()</span>
<span id="cb49-332"><a href="#cb49-332" aria-hidden="true" tabindex="-1"></a>p.layout.title.text <span class="op">=</span> <span class="st">"knn distance histogram - multimodal "</span></span>
<span id="cb49-333"><a href="#cb49-333" aria-hidden="true" tabindex="-1"></a>p.<span class="fu">histogram</span>(x<span class="op">=</span><span class="fu">convert</span>.(<span class="dt">Float32</span>, <span class="fu">view</span>(eknns, <span class="fl">10</span>, <span class="op">:</span>)))</span>
<span id="cb49-334"><a href="#cb49-334" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-335"><a href="#cb49-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-336"><a href="#cb49-336" aria-hidden="true" tabindex="-1"></a><span class="fu">## Búsqueda con índice</span></span>
<span id="cb49-337"><a href="#cb49-337" aria-hidden="true" tabindex="-1"></a>Ahora veremos como hacerlo más eficiente</span>
<span id="cb49-340"><a href="#cb49-340" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-341"><a href="#cb49-341" aria-hidden="true" tabindex="-1"></a>G <span class="op">=</span> <span class="fu">SearchGraph</span>(; db, dist)</span>
<span id="cb49-342"><a href="#cb49-342" aria-hidden="true" tabindex="-1"></a>gctx <span class="op">=</span> <span class="fu">SearchGraphContext</span>(</span>
<span id="cb49-343"><a href="#cb49-343" aria-hidden="true" tabindex="-1"></a>  hyperparameters_callback<span class="op">=</span><span class="fu">OptimizeParameters</span>(<span class="fu">MinRecall</span>(<span class="fl">0.99</span>))</span>
<span id="cb49-344"><a href="#cb49-344" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-345"><a href="#cb49-345" aria-hidden="true" tabindex="-1"></a><span class="pp">@time</span> <span class="fu">index!</span>(G, gctx)</span>
<span id="cb49-346"><a href="#cb49-346" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-347"><a href="#cb49-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-348"><a href="#cb49-348" aria-hidden="true" tabindex="-1"></a>Optimizamos para cierta calidad</span>
<span id="cb49-351"><a href="#cb49-351" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-352"><a href="#cb49-352" aria-hidden="true" tabindex="-1"></a><span class="pp">@time</span> <span class="fu">optimize_index!</span>(G, gctx, <span class="fu">MinRecall</span>(<span class="fl">0.9</span>))</span>
<span id="cb49-353"><a href="#cb49-353" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-354"><a href="#cb49-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-355"><a href="#cb49-355" aria-hidden="true" tabindex="-1"></a>Vamos a buscar en el índice</span>
<span id="cb49-358"><a href="#cb49-358" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-359"><a href="#cb49-359" aria-hidden="true" tabindex="-1"></a><span class="pp">@time</span> gknns <span class="op">=</span> <span class="fu">searchbatch</span>(G, gctx, queries, <span class="fl">10</span>)</span>
<span id="cb49-360"><a href="#cb49-360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-361"><a href="#cb49-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-362"><a href="#cb49-362" aria-hidden="true" tabindex="-1"></a>Vamos observar algunas de las consultas</span>
<span id="cb49-365"><a href="#cb49-365" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-366"><a href="#cb49-366" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> DQ[qID, <span class="op">:</span>]</span>
<span id="cb49-367"><a href="#cb49-367" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(<span class="fu">Dict</span>(<span class="fu">pairs</span>(r)))</span>
<span id="cb49-368"><a href="#cb49-368" aria-hidden="true" tabindex="-1"></a>h.<span class="fu">img</span>(src<span class="op">=</span>r.image_url, alt<span class="op">=</span>r.page_title, width<span class="op">=</span><span class="fl">160</span>)</span>
<span id="cb49-369"><a href="#cb49-369" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-370"><a href="#cb49-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-371"><a href="#cb49-371" aria-hidden="true" tabindex="-1"></a>Y sus resultados</span>
<span id="cb49-374"><a href="#cb49-374" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-375"><a href="#cb49-375" aria-hidden="true" tabindex="-1"></a>children <span class="op">=</span> []</span>
<span id="cb49-376"><a href="#cb49-376" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> <span class="fu">view</span>(gknns, <span class="op">:</span>, qID)</span>
<span id="cb49-377"><a href="#cb49-377" aria-hidden="true" tabindex="-1"></a>  r <span class="op">=</span> D[p.id, [<span class="op">:</span>image_url, <span class="op">:</span>page_url, <span class="op">:</span>page_title]]</span>
<span id="cb49-378"><a href="#cb49-378" aria-hidden="true" tabindex="-1"></a>  <span class="fu">push!</span>(children,</span>
<span id="cb49-379"><a href="#cb49-379" aria-hidden="true" tabindex="-1"></a>    h.<span class="fu">div</span>(style<span class="op">=</span><span class="st">"display: inline-block; margin-left: 0.25cm;"</span>,</span>
<span id="cb49-380"><a href="#cb49-380" aria-hidden="true" tabindex="-1"></a>      h.<span class="fu">img</span>(src<span class="op">=</span>r.image_url, alt<span class="op">=</span>r.page_title, width<span class="op">=</span><span class="fl">160</span>), h.<span class="fu">br</span>(),</span>
<span id="cb49-381"><a href="#cb49-381" aria-hidden="true" tabindex="-1"></a>      h.<span class="fu">a</span>(r.page_title, href<span class="op">=</span>r.page_url)</span>
<span id="cb49-382"><a href="#cb49-382" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-383"><a href="#cb49-383" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb49-384"><a href="#cb49-384" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb49-385"><a href="#cb49-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-386"><a href="#cb49-386" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> h.<span class="fu">div</span>(children)</span>
<span id="cb49-387"><a href="#cb49-387" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-388"><a href="#cb49-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-389"><a href="#cb49-389" aria-hidden="true" tabindex="-1"></a>Sus histogramas</span>
<span id="cb49-392"><a href="#cb49-392" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-393"><a href="#cb49-393" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> <span class="fu">plot</span>()</span>
<span id="cb49-394"><a href="#cb49-394" aria-hidden="true" tabindex="-1"></a>p.layout.title.text <span class="op">=</span> <span class="st">"knn distance histogram - indexed - multimodal "</span></span>
<span id="cb49-395"><a href="#cb49-395" aria-hidden="true" tabindex="-1"></a>p.<span class="fu">histogram</span>(x<span class="op">=</span><span class="fu">convert</span>.(<span class="dt">Float32</span>, <span class="fu">view</span>(gknns, <span class="fl">10</span>, <span class="op">:</span>)))</span>
<span id="cb49-396"><a href="#cb49-396" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-397"><a href="#cb49-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-398"><a href="#cb49-398" aria-hidden="true" tabindex="-1"></a>Ahora medimos el recall</span>
<span id="cb49-401"><a href="#cb49-401" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-402"><a href="#cb49-402" aria-hidden="true" tabindex="-1"></a><span class="fu">macrorecall</span>(eknns, gknns)</span>
<span id="cb49-403"><a href="#cb49-403" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-404"><a href="#cb49-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-405"><a href="#cb49-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-406"><a href="#cb49-406" aria-hidden="true" tabindex="-1"></a>Vemos que no es tan bueno, pero es básicamente porque intercambiamos velocidad por calidad. A continuación veremos como mejorar un poco la calidad, manipulando algunos de los parametros de búsqueda.</span>
<span id="cb49-407"><a href="#cb49-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-410"><a href="#cb49-410" aria-hidden="true" tabindex="-1"></a><span class="in">```{julia}</span></span>
<span id="cb49-411"><a href="#cb49-411" aria-hidden="true" tabindex="-1"></a>B_ <span class="op">=</span> B <span class="op">=</span> G.algo[]</span>
<span id="cb49-412"><a href="#cb49-412" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="kw">in</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span></span>
<span id="cb49-413"><a href="#cb49-413" aria-hidden="true" tabindex="-1"></a>  G.algo[] <span class="op">=</span> B <span class="op">=</span> <span class="fu">BeamSearch</span>(B.bsize, B.Δ, <span class="fl">3</span> <span class="op">*</span> B.maxvisits)</span>
<span id="cb49-414"><a href="#cb49-414" aria-hidden="true" tabindex="-1"></a>  <span class="pp">@time</span> <span class="st">"searching </span><span class="sc">$</span>B<span class="st">"</span> gknns <span class="op">=</span> <span class="fu">searchbatch</span>(G, gctx, queries, <span class="fl">10</span>)</span>
<span id="cb49-415"><a href="#cb49-415" aria-hidden="true" tabindex="-1"></a>  <span class="pp">@info</span> <span class="fu">macrorecall</span>(eknns, gknns)</span>
<span id="cb49-416"><a href="#cb49-416" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb49-417"><a href="#cb49-417" aria-hidden="true" tabindex="-1"></a>G.algo[] <span class="op">=</span> B_</span>
<span id="cb49-418"><a href="#cb49-418" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-419"><a href="#cb49-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-420"><a href="#cb49-420" aria-hidden="true" tabindex="-1"></a></span>
</code></pre></div><button title="Copiar al portapapeles" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Eric S. Tellez</p>
</div>   
    <div class="nav-footer-center">
<p>Esta obra está bajo una <a href="http://creativecommons.org/licenses/by-sa/4.0/">Licencia Creative Commons Atribución-CompartirIgual 4.0 Internacional</a></p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>